<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>爱小说</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <script>
    tailwind.config = {
      darkMode: 'class', // <-- 启用 Dark Mode
      theme: {
        extend: {
          colors: {
            primary: '#4F46E5',
            secondary: '#10B981',
            accent: '#F59E0B',
            dark: '#111827', // 更深的背景
            light: '#F8FAFC',
            'slate-800': '#1E293B',
            'slate-700': '#334155',
            'slate-600': '#475569',
          },
          fontFamily: {
            sans: ['Inter', 'system-ui', 'sans-serif'],
            reading: ['var(--reading-font)', 'Inter', 'system-ui', 'sans-serif'],
          },
        },
      }
    }
  </script>
  <style type="text/tailwindcss">
    @layer base {
      :root {
        --reading-font: 'Inter';
        --reading-font-size: 1.125rem; /* 18px */
        --reading-line-height: 1.75;
        --reading-letter-spacing: 0.025em;
        --reading-bg-color: #ffffff;
        --reading-text-color: #334155; /* slate-700 */
        --dialogue-highlight-color: #334155;
        --dialogue-highlight-weight: normal;
      }
      /* Dark mode variables */
      :root.dark {
        --reading-bg-color: #1E293B; /* slate-800 */
        --reading-text-color: #cbd5e1; /* slate-300 */
        --dialogue-highlight-color: #cbd5e1; /* slate-300 */
      }
    }
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .text-shadow {
        text-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      .transition-custom {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }
      .scrollbar-hide::-webkit-scrollbar {
        display: none;
      }
      .scrollbar-hide {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }
      .tab-button.active {
        @apply bg-primary/10 text-primary border-primary dark:bg-primary/20;
      }
      .dialogue-highlight {
        color: var(--dialogue-highlight-color);
        font-weight: var(--dialogue-highlight-weight);
      }
    }
  </style>
</head>
<body class="bg-gray-100 font-sans text-gray-800 min-h-screen flex flex-col dark:bg-dark dark:text-light">
  <!-- 顶部导航栏 -->
  <header class="bg-white shadow-sm sticky top-0 z-50 dark:bg-slate-800 dark:border-b dark:border-slate-700">
    <div class="container mx-auto px-4 py-3 flex justify-between items-center">
      <h1 class="text-2xl font-bold text-primary flex items-center">
        <i class="fa fa-book mr-2"></i>爱小说
      </h1>
      <div class="flex items-center space-x-2">
        <button id="custom-prompt-btn" class="p-1 rounded-md hover:bg-gray-100 dark:hover:bg-slate-700 transition-custom" title="自定义情节">
          <i class="fa fa-magic text-gray-600 dark:text-gray-300"></i>
        </button>
        <button id="continue-story" class="p-1 rounded-md hover:bg-gray-100 dark:hover:bg-slate-700 transition-custom" title="继续故事">
          <i class="fa fa-play text-gray-600 dark:text-gray-300"></i>
        </button>
        <button id="regenerate-chapter" class="p-1 rounded-md hover:bg-gray-100 dark:hover:bg-slate-700 transition-custom" title="重新生成">
          <i class="fa fa-refresh text-gray-600 dark:text-gray-300"></i>
        </button>
        <span class="text-gray-300 mx-1">|</span>
        <button id="open-model-settings" class="p-1 rounded-md hover:bg-gray-100 dark:hover:bg-slate-700 transition-custom" title="配置模型">
          <i class="fa fa-cogs text-gray-600 dark:text-gray-300"></i>
        </button>
        <button id="open-story-preset" class="p-1 rounded-md hover:bg-gray-100 dark:hover:bg-slate-700 transition-custom" title="设置故事">
          <i class="fa fa-file-text-o text-gray-600 dark:text-gray-300"></i>
        </button>
        <button id="theme-toggle" class="p-1 rounded-md hover:bg-gray-100 dark:hover:bg-slate-700 transition-custom">
          <i class="fa fa-moon-o text-gray-600 dark:text-gray-300"></i>
        </button>
      </div>
    </div>
  </header>

  <main class="flex-grow container mx-auto px-4 py-6 flex flex-col">
    <!-- 生成控制栏 -->
    <div class="bg-white rounded-xl shadow-sm p-4 mb-6 flex flex-wrap gap-2 justify-between items-center transition-custom hover:shadow-md dark:bg-slate-800">
      <div class="flex items-center space-x-2">
        <button id="prev-chapter" class="px-2 py-2 bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 transition-custom flex items-center disabled:opacity-50 disabled:cursor-not-allowed dark:bg-slate-700 dark:text-gray-300 dark:hover:bg-slate-600 text-sm" disabled>
          <i class="fa fa-arrow-left mr-1"></i>上章
        </button>
        <span id="chapter-info" class="text-sm text-gray-500 px-2 dark:text-gray-400">第 1 / 1 章</span>
        <button id="next-chapter" class="px-2 py-2 bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 transition-custom flex items-center disabled:opacity-50 disabled:cursor-not-allowed dark:bg-slate-700 dark:text-gray-300 dark:hover:bg-slate-600 text-sm">
          下章 <i class="fa fa-arrow-right ml-1"></i>
        </button>
      </div>
    </div>

    <!-- 阅读区域 -->
    <div id="reading-area-wrapper" class="bg-white rounded-xl shadow-sm overflow-hidden flex-grow transition-custom hover:shadow-md flex flex-col" style="background-color: var(--reading-bg-color);">
      <div id="reading-area" class="p-8 md:p-10 lg:p-12 min-h-[500px] relative flex-grow overflow-y-auto scrollbar-hide" style="color: var(--reading-text-color); font-family: var(--reading-font); font-size: var(--reading-font-size); line-height: var(--reading-line-height); letter-spacing: var(--reading-letter-spacing);">
        <!-- 加载状态 -->
        <div id="loading-state" class="absolute inset-0 flex items-center justify-center bg-white/80 dark:bg-slate-800/80 z-10 hidden">
          <div class="text-center">
            <div class="inline-block animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-primary mb-4"></div>
            <p class="text-gray-600 dark:text-gray-300">AI创作中...</p>
            <div class="mt-3 w-64">
              <div class="bg-gray-200 dark:bg-slate-600 rounded-full h-2.5">
                <div id="progress-bar" class="bg-primary h-2.5 rounded-full" style="width: 0%"></div>
              </div>
              <p id="progress-text" class="text-xs text-gray-500 dark:text-gray-400 mt-1">准备中...</p>
            </div>
          </div>
        </div>

        <!-- 内容区域 -->
        <div id="content-area-container">
          <h1 id="chapter-title-display" class="text-3xl md:text-4xl font-bold mb-6 text-center" style="color: var(--reading-text-color);"></h1>
          <div id="content-area" class="prose max-w-none">
            <!-- Paginated content will be loaded by JS -->
          </div>
        </div>
      </div>

      <!-- 底部工具栏 -->
      <div class="bg-gray-50/50 border-t border-gray-200/80 p-3 flex justify-between items-center backdrop-blur-sm dark:bg-slate-800/80 dark:border-t-slate-700">
        <div class="flex items-center space-x-3">
          <div class="text-sm text-gray-500 dark:text-gray-400">
            <i class="fa fa-file-word-o mr-1"></i>字数: <span id="word-count">0</span>
          </div>
          <!-- Pagination Controls -->
          <div id="pagination-controls" class="flex items-center space-x-1 hidden">
              <button id="prev-page" class="p-1 rounded-md hover:bg-gray-200 dark:hover:bg-slate-700 disabled:opacity-50 disabled:cursor-not-allowed" title="上一页">
                  <i class="fa fa-chevron-left text-gray-600 dark:text-gray-300 text-sm"></i>
              </button>
              <span id="page-info" class="text-xs text-gray-500 dark:text-gray-400 px-1"></span>
              <button id="next-page" class="p-1 rounded-md hover:bg-gray-200 dark:hover:bg-slate-700 disabled:opacity-50 disabled:cursor-not-allowed" title="下一页">
                  <i class="fa fa-chevron-right text-gray-600 dark:text-gray-300 text-sm"></i>
              </button>
          </div>
        </div>
        <div class="flex space-x-1">
          <button id="edit-chapter" class="p-1.5 rounded-md hover:bg-gray-200 dark:hover:bg-slate-700 transition-custom" title="编辑章节">
            <i class="fa fa-edit text-gray-600 dark:text-gray-300 text-sm"></i>
          </button>
          <button id="open-settings" class="p-1.5 rounded-md hover:bg-gray-200 dark:hover:bg-slate-700 transition-custom" title="阅读设置">
            <i class="fa fa-sliders text-gray-600 dark:text-gray-300 text-sm"></i>
          </button>
          <button id="export-chapter" class="p-1.5 rounded-md hover:bg-gray-200 dark:hover:bg-slate-700 transition-custom" title="导出本章">
            <i class="fa fa-download text-gray-600 dark:text-gray-300 text-sm"></i>
          </button>
          <button id="export-all-chapters" class="p-1.5 rounded-md hover:bg-gray-200 dark:hover:bg-slate-700 transition-custom" title="导出全部">
            <i class="fa fa-save text-gray-600 dark:text-gray-300 text-sm"></i>
          </button>
        </div>
      </div>
    </div>
  </main>

  <!-- 阅读设置模态框 -->
  <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden p-4">
    <div class="bg-white rounded-xl shadow-xl w-full max-w-md max-h-[90vh] flex flex-col dark:bg-slate-800">
      <div class="p-5 border-b border-gray-200 flex justify-between items-center dark:border-slate-700">
        <h3 class="text-lg font-semibold text-primary">阅读设置</h3>
        <button id="close-settings" class="p-2 rounded-full hover:bg-gray-100 transition-custom dark:hover:bg-slate-700">
          <i class="fa fa-times text-gray-600 dark:text-gray-300"></i>
        </button>
      </div>
      <div class="p-6 space-y-6 overflow-y-auto">
        <!-- 字体设置 -->
        <div>
          <h4 class="text-md font-medium text-gray-700 mb-3 dark:text-gray-300"><i class="fa fa-font mr-2 text-primary"></i>字体样式</h4>
          <div class="space-y-4">
              <div>
                  <label for="font-size-slider" class="block text-sm font-medium text-gray-600 mb-1 dark:text-gray-400">字体大小: <span id="font-size-value">18px</span></label>
                  <input type="range" id="font-size-slider" min="12" max="32" step="1" value="18" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-slate-600">
              </div>
              <div>
                  <label for="line-height-slider" class="block text-sm font-medium text-gray-600 mb-1 dark:text-gray-400">行间距: <span id="line-height-value">1.75</span></label>
                  <input type="range" id="line-height-slider" min="1.2" max="2.5" step="0.05" value="1.75" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-slate-600">
              </div>
              <div>
                  <label for="letter-spacing-slider" class="block text-sm font-medium text-gray-600 mb-1 dark:text-gray-400">字间距: <span id="letter-spacing-value">0.025em</span></label>
                  <input type="range" id="letter-spacing-slider" min="0" max="0.1" step="0.005" value="0.025" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-slate-600">
              </div>
          </div>
        </div>
        <!-- 自定义字体 -->
        <div>
          <h4 class="text-md font-medium text-gray-700 mb-3 dark:text-gray-300"><i class="fa fa-upload mr-2 text-primary"></i>自定义字体</h4>
          <input type="file" id="font-upload" accept=".ttf,.otf,.woff,.woff2" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-primary/10 file:text-primary hover:file:bg-primary/20 cursor-pointer dark:text-gray-400 dark:file:bg-primary/20 dark:hover:file:bg-primary/30">
          <p class="text-xs text-gray-500 mt-1 dark:text-gray-400">上传 .ttf 或 .otf 格式字体文件，仅在阅读区生效。</p>
        </div>
        <!-- 对话高亮 -->
        <div>
          <h4 class="text-md font-medium text-gray-700 mb-3 dark:text-gray-300"><i class="fa fa-comments-o mr-2 text-primary"></i>对话高亮</h4>
          <div class="space-y-3">
              <label class="flex items-center space-x-3 cursor-pointer">
                  <input type="checkbox" id="dialogue-bold-toggle" class="h-4 w-4 rounded border-gray-300 text-primary focus:ring-primary dark:bg-slate-700 dark:border-slate-600">
                  <span class="text-sm font-medium text-gray-700 dark:text-gray-300">对话内容加粗</span>
              </label>
              <div class="flex items-center space-x-3">
                  <label for="dialogue-color-picker" class="text-sm font-medium text-gray-700 dark:text-gray-300">对话文字颜色:</label>
                  <input type="color" id="dialogue-color-picker" value="#334155" class="w-10 h-8 p-1 border border-gray-300 rounded-md cursor-pointer dark:bg-slate-700 dark:border-slate-600">
                  <button id="reset-dialogue-color" class="text-xs text-gray-500 hover:text-primary dark:text-gray-400 dark:hover:text-primary">重置</button>
              </div>
              <p class="text-xs text-gray-500 mt-1 dark:text-gray-400">注意：对话高亮在“HTML”输出格式下无效。</p>
                        </div>
              
                        <!-- 数据同步功能 -->
                        <div class="mt-8 pt-6 border-t border-gray-200 dark:border-slate-700">
                            <h2 class="text-lg font-semibold mb-4 flex items-center text-primary">
                                <i class="fa fa-exchange mr-2"></i>数据同步（挖坑中 暂不可用）
                            </h2>
                            <div class="space-y-4">
                                <div class="flex flex-wrap gap-2">
                                    <button id="export-config" class="px-4 py-2 bg-primary/10 text-primary rounded-md hover:bg-primary/20 transition-custom">
                                        <i class="fa fa-download mr-2"></i>导出配置
                                    </button>
                                    <button id="export-all-data" class="px-4 py-2 bg-primary/10 text-primary rounded-md hover:bg-primary/20 transition-custom">
                                        <i class="fa fa-save mr-2"></i>导出全部数据
                                    </button>
                                    <label for="import-data" class="px-4 py-2 bg-primary/10 text-primary rounded-md hover:bg-primary/20 transition-custom cursor-pointer">
                                        <i class="fa fa-upload mr-2"></i>导入数据
                                        <input type="file" id="import-data" accept=".json" class="hidden">
                                    </label>
                                </div>
                                <p class="text-xs text-gray-500 dark:text-gray-400">
                                    导出配置包含API设置和故事预设，导出全部数据还包括生成的文章内容
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
          </div>

          <script>
          // 导出当前配置(不含文章)
          document.getElementById('export-config').addEventListener('click', () => {
              const configData = {
                  apiSettings: {
                      type: document.getElementById('api-type').value,
                      url: document.getElementById('api-url').value,
                      key: document.getElementById('api-key').value
                  },
                  modelSettings: {
                      model: document.getElementById('model-select').value,
                      contextMemory: document.getElementById('context-memory').value,
                      temperature: document.getElementById('temperature').value
                  },
                  meta: {
                      version: "1.0",
                      exportType: "config",
                      timestamp: new Date().toISOString()
                  }
              };
    
              const blob = new Blob([JSON.stringify(configData, null, 2)], {type: 'application/json'});
              const url = URL.createObjectURL(blob);
              const a = document.createElement('a');
              a.href = url;
              a.download = `story-config-${new Date().toLocaleDateString()}.json`;
              a.click();
              URL.revokeObjectURL(url);
          });

          // 导出全部数据(包含文章)
          document.getElementById('export-all-data').addEventListener('click', () => {
              const allData = {
                  apiSettings: {
                      type: document.getElementById('api-type').value,
                      url: document.getElementById('api-url').value,
                      key: document.getElementById('api-key').value
                  },
                  modelSettings: {
                      model: document.getElementById('model-select').value,
                      contextMemory: document.getElementById('context-memory').value,
                      temperature: document.getElementById('temperature').value
                  },
                  storyChapters: window.story || [],
                  meta: {
                      version: "1.0",
                      exportType: "full",
                      timestamp: new Date().toISOString()
                  }
              };
    
              const blob = new Blob([JSON.stringify(allData, null, 2)], {type: 'application/json'});
              const url = URL.createObjectURL(blob);
              const a = document.createElement('a');
              a.href = url;
              a.download = `story-backup-${new Date().toLocaleDateString()}.json`;
              a.click();
              URL.revokeObjectURL(url);
          });

          // 导入数据处理
          document.getElementById('import-data').addEventListener('change', function(e) {
              if (e.target.files.length === 0) return;
    
              const file = e.target.files[0];
              const reader = new FileReader();
    
              reader.onload = (event) => {
                  try {
                      const data = JSON.parse(event.target.result);
            
                      if (data.meta.exportType === 'config') {
                          // 导入配置
                          if (data.apiSettings) {
                              document.getElementById('api-type').value = data.apiSettings.type || 'openai';
                              document.getElementById('api-url').value = data.apiSettings.url || '';
                              document.getElementById('api-key').value = data.apiSettings.key || '';
                          }
                
                          if (data.modelSettings) {
                              document.getElementById('model-select').value = data.modelSettings.model || '';
                              document.getElementById('context-memory').value = data.modelSettings.contextMemory || 3;
                              document.getElementById('temperature').value = data.modelSettings.temperature || 0.7;
                          }
                
                          alert('配置导入成功！');
                      } else {
                          // 导入全部数据
                          if (data.apiSettings) {
                              document.getElementById('api-type').value = data.apiSettings.type || 'openai';
                              document.getElementById('api-url').value = data.apiSettings.url || '';
                              document.getElementById('api-key').value = data.apiSettings.key || '';
                          }
                
                          if (data.modelSettings) {
                              document.getElementById('model-select').value = data.modelSettings.model || '';
                              document.getElementById('context-memory').value = data.modelSettings.contextMemory || 3;
                              document.getElementById('temperature').value = data.modelSettings.temperature || 0.7;
                          }
                
                          if (data.storyChapters && Array.isArray(data.storyChapters)) {
                              window.story = data.storyChapters;
                              if (window.story.length > 0) {
                                  window.currentChapterIndex = 0;
                                  window.renderChapter(0);
                              }
                          }
                
                          alert('数据导入成功！已恢复' + (data.storyChapters?.length || 0) + '个章节');
                      }
                  } catch (error) {
                      console.error('导入失败:', error);
                      alert('导入失败：文件格式不正确或已损坏');
                  }
              };
    
              reader.readAsText(file);
          });
          </script>
  </div>

  <!-- 自定义生成模态框 -->
  <div id="custom-prompt-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden p-4">
      <div class="bg-white rounded-xl shadow-xl w-full max-w-lg dark:bg-slate-800">
          <div class="p-5 border-b border-gray-200 flex justify-between items-center dark:border-slate-700">
              <h3 class="text-lg font-semibold text-primary">自定义生成</h3>
              <button id="close-custom-prompt" class="p-2 rounded-full hover:bg-gray-100 transition-custom dark:hover:bg-slate-700">
                  <i class="fa fa-times text-gray-600 dark:text-gray-300"></i>
              </button>
          </div>
          <div class="p-6">
              <textarea id="custom-prompt-input" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary h-40 dark:bg-slate-700 dark:border-slate-600 dark:text-light dark:placeholder-gray-400" placeholder="请输入你希望接下来发生的情节..."></textarea>
              <div class="mt-4 flex justify-end">
                  <button id="submit-custom-prompt" class="px-6 py-2 bg-secondary text-white rounded-md hover:bg-secondary/90 transition-custom">生成</button>
              </div>
          </div>
      </div>
  </div>

  <!-- 编辑章节模态框 -->
  <div id="edit-chapter-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden p-4">
      <div class="bg-white rounded-xl shadow-xl w-full max-w-4xl max-h-[90vh] flex flex-col dark:bg-slate-800">
          <div class="p-5 border-b border-gray-200 flex justify-between items-center dark:border-slate-700">
              <h3 class="text-lg font-semibold text-primary">编辑章节</h3>
              <button id="close-edit-chapter" class="p-2 rounded-full hover:bg-gray-100 transition-custom dark:hover:bg-slate-700">
                  <i class="fa fa-times text-gray-600 dark:text-gray-300"></i>
              </button>
          </div>
          <div class="p-6 flex-grow flex flex-col">
              <div class="mb-4">
                  <label for="edit-chapter-title" class="block text-sm font-medium text-gray-700 mb-1 dark:text-gray-300">章节标题</label>
                  <input type="text" id="edit-chapter-title" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary dark:bg-slate-700 dark:border-slate-600 dark:text-light">
              </div>
              <div class="flex-grow flex flex-col">
                  <label for="edit-chapter-content" class="block text-sm font-medium text-gray-700 mb-1 dark:text-gray-300">章节内容</label>
                  <textarea id="edit-chapter-content" class="flex-grow w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary resize-none dark:bg-slate-700 dark:border-slate-600 dark:text-light" style="min-height: 300px;"></textarea>
              </div>
              <div class="mt-4 flex justify-between items-center">
                  <button id="delete-chapter" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-custom flex items-center">
                      <i class="fa fa-trash mr-2"></i>删除章节
                  </button>
                  <div class="flex space-x-2">
                      <button id="cancel-edit" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400 transition-custom">取消</button>
                      <button id="save-edit" class="px-6 py-2 bg-primary text-white rounded-md hover:bg-primary/90 transition-custom">保存</button>
                  </div>
              </div>
          </div>
      </div>
  </div>

  <!-- 模型设置模态框 -->
  <div id="model-settings-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden p-4">
      <div class="bg-white rounded-xl shadow-xl w-full max-w-2xl max-h-[90vh] flex flex-col dark:bg-slate-800">
          <div class="p-5 border-b border-gray-200 flex justify-between items-center dark:border-slate-700">
              <h3 class="text-lg font-semibold text-primary">模型设置</h3>
              <button id="close-model-settings" class="p-2 rounded-full hover:bg-gray-100 transition-custom dark:hover:bg-slate-700">
                  <i class="fa fa-times text-gray-600 dark:text-gray-300"></i>
              </button>
          </div>
          <div class="p-6 space-y-6 overflow-y-auto">
              <!-- API 配置面板 -->
              <div>
                  <h2 class="text-lg font-semibold mb-4 flex items-center text-primary">
                      <i class="fa fa-plug mr-2"></i>API 配置
                  </h2>
                  <form id="api-form" class="space-y-3">
                      <div>
                          <label for="api-type" class="block text-sm font-medium text-gray-700 mb-1 dark:text-gray-300">API 类型</label>
                          <select id="api-type" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary dark:bg-slate-700 dark:border-slate-600 dark:text-light">
                              <option value="openai" selected>OpenAI</option>
                              <option value="gemini">Gemini</option>
                          </select>
                      </div>
                      <div>
                          <label for="api-url" class="block text-sm font-medium text-gray-700 mb-1 dark:text-gray-300">API 地址</label>
                          <input type="url" id="api-url" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary dark:bg-slate-700 dark:border-slate-600 dark:text-light dark:placeholder-gray-400" placeholder="https://api.openai.com/v1/chat/completions">
                      </div>
                      <div>
                          <label for="api-key" class="block text-sm font-medium text-gray-700 mb-1 dark:text-gray-300">API Key</label>
                          <div class="relative">
                              <input type="password" id="api-key" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary dark:bg-slate-700 dark:border-slate-600 dark:text-light dark:placeholder-gray-400" placeholder="sk-xxxxxxxxxxxxxxxxxxxxxxxx">
                              <button type="button" id="toggle-key" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                                  <i class="fa fa-eye"></i>
                              </button>
                          </div>
                      </div>
                      <button type="button" id="connect-api" class="w-full bg-primary text-white py-2 px-4 rounded-md hover:bg-primary/90 transition-custom flex items-center justify-center disabled:opacity-75 disabled:cursor-wait">
                          <i class="fa fa-connectdevelop mr-2"></i>连接模型
                      </button>
                      <div id="api-status" class="hidden text-sm py-2 px-3 rounded-md"></div>
                  </form>
              </div>
              <!-- 模型与参数设置 -->
              <div>
                  <h2 class="text-lg font-semibold mb-4 flex items-center text-primary">
                    <i class="fa fa-sliders mr-2"></i>生成参数
                  </h2>
                  <div class="space-y-3">
                    <div>
                      <label for="model-select" class="block text-sm font-medium text-gray-700 mb-1 dark:text-gray-300">选择模型</label>
                      <select id="model-select" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary dark:bg-slate-700 dark:border-slate-600 dark:text-light" disabled>
                        <option value="">请先连接API</option>
                      </select>
                    </div>
                    <div>
                      <label for="context-memory" class="block text-sm font-medium text-gray-700 mb-1 dark:text-gray-300">上下文记忆 (最近章节数)</label>
                      <div class="flex items-center">
                        <input type="range" id="context-memory" min="0" max="50" value="3" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-slate-600">
                        <span id="memory-value" class="ml-4 text-sm font-medium w-12 text-right dark:text-gray-300">3章</span>
                      </div>
                    </div>
                    <div>
                      <label for="temperature" class="block text-sm font-medium text-gray-700 mb-1 dark:text-gray-300">创意温度</label>
                      <div class="flex items-center">
                        <input type="range" id="temperature" min="0.1" max="1.5" step="0.1" value="0.7" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-slate-600">
                        <span id="temperature-value" class="ml-4 text-sm font-medium w-12 text-right dark:text-gray-300">0.7</span>
                      </div>
                    </div>
                  </div>
              </div>
          </div>
      </div>
  </div>

  <!-- 故事预设模态框 -->
  <div id="story-preset-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden p-4">
    <div class="bg-white rounded-xl shadow-xl w-full max-w-2xl max-h-[90vh] flex flex-col dark:bg-slate-800">
      <div class="p-5 border-b border-gray-200 flex justify-between items-center dark:border-slate-700">
        <h3 class="text-lg font-semibold text-primary">故事预设</h3>
        <button id="close-story-preset" class="p-1 rounded-md hover:bg-gray-100 transition-custom dark:hover:bg-slate-700">
          <i class="fa fa-times text-gray-600 dark:text-gray-300"></i>
        </button>
      </div>
      <div class="p-6 space-y-6 overflow-y-auto">
        <div class="flex justify-between items-center mb-4">
          <div class="flex space-x-1">
            <button class="tab-btn-preset p-2 rounded-md text-sm w-8 h-8 flex items-center justify-center" 
                    data-tab="character" title="人设">
              <i class="fa fa-user text-xs"></i>
            </button>
            <button class="tab-btn-preset p-2 rounded-md text-sm w-8 h-8 flex items-center justify-center" 
                    data-tab="player" title="玩家人设">
              <i class="fa fa-user-circle text-xs"></i>
            </button>
            <button class="tab-btn-preset p-2 rounded-md text-sm w-8 h-8 flex items-center justify-center" 
                    data-tab="world" title="世界观">
              <i class="fa fa-globe text-xs"></i>
            </button>
            <button class="tab-btn-preset p-2 rounded-md text-sm w-8 h-8 flex items-center justify-center" 
                    data-tab="style" title="文风">
              <i class="fa fa-paint-brush text-xs"></i>
            </button>
            <button class="tab-btn-preset p-2 rounded-md text-sm w-8 h-8 flex items-center justify-center" 
                    data-tab="script" title="剧本">
              <i class="fa fa-file-text text-xs"></i>
            </button>
            <button class="tab-btn-preset p-2 rounded-md text-sm w-8 h-8 flex items-center justify-center" 
                    data-tab="format" title="内容格式">
              <i class="fa fa-code text-xs"></i>
            </button>
          </div>
          <button id="clear-all-presets" class="text-xs text-gray-500 hover:text-primary flex items-center">
            <i class="fa fa-times-circle mr-1"></i>清空选择
          </button>
        </div>
        <div id="preset-tab-content">
          <!-- 动态内容区 -->
        </div>
        
        <!-- 已选择项目总览 -->
        <div id="selected-presets-summary" class="mt-6 pt-4 border-t border-gray-200 dark:border-slate-700 hidden">
          <h4 class="text-sm font-medium text-gray-700 mb-2 dark:text-gray-300">已选择的预设</h4>
          <div class="flex flex-wrap gap-2" id="selected-presets-tags"></div>
        </div>
        
        <!-- 生成故事按钮 -->
        <div class="mt-6 flex justify-center">
          <button id="generate-from-presets" class="px-6 py-2 bg-secondary text-white rounded-md hover:bg-secondary/90 transition-custom flex items-center">
            <i class="fa fa-magic mr-2"></i>根据选择生成故事
          </button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/showdown@2.1.0/dist/showdown.min.js"></script>
  <script>
    // --- START: FULLY FUNCTIONAL JAVASCRIPT CODE ---
    document.addEventListener('DOMContentLoaded', () => {
    // --- STATE MANAGEMENT ---
    let story = [];
    let currentChapterIndex = 0;
    let chapterPages = [];
    let currentPageIndex = 0;
    const mdConverter = new showdown.Converter({ noHeaderId: true, simplifiedAutoLink: true, openLinksInNewWindow: true });
    let apiConfig = {
      type: 'openai', // 'openai' or 'gemini'
      url: 'https://cdn.generativelanguage.googleapis.com', // 默认填Gemini地址
      key: '',
      isConnected: false,
    };

    // --- 轮询API KEY ---
    let apiKeyList = [];
    let apiKeyIndex = 0;
    function parseApiKeys() {
      apiKeyList = elements.apiKey.value.split(',').map(k => k.trim()).filter(Boolean);
      if (apiKeyList.length === 0) apiKeyList = [''];
      if (apiKeyIndex >= apiKeyList.length) apiKeyIndex = 0;
    }
    function getCurrentApiKey() {
      if (apiKeyList.length === 0) parseApiKeys();
      return apiKeyList[apiKeyIndex] || '';
    }
    function nextApiKey() {
      apiKeyIndex = (apiKeyIndex + 1) % apiKeyList.length;
    }

    // --- DOM ELEMENTS ---
    const elements = {
      themeToggle: document.getElementById('theme-toggle'),
      apiType: document.getElementById('api-type'),
      apiUrl: document.getElementById('api-url'),
      apiKey: document.getElementById('api-key'),
      toggleKeyBtn: document.getElementById('toggle-key'),
      connectApiBtn: document.getElementById('connect-api'),
      apiStatus: document.getElementById('api-status'),
      modelSelect: document.getElementById('model-select'),
      contextMemorySlider: document.getElementById('context-memory'),
      memoryValue: document.getElementById('memory-value'),
      temperatureSlider: document.getElementById('temperature'),
      temperatureValue: document.getElementById('temperature-value'),
      // 创建缺失的元素引用
      presetUpload: { addEventListener: () => {} }, // 空对象模拟
      presetText: { value: `### 故事设定\n\n### 人物设定\你\n### 世界观设定\穿书\n### 文风设定\穿书\n### 剧本设定\穿书\n### 内容格式设定\使用markdown格式\n### 生成规则\n\n### 生成内容\n\n### 生成内容\n\n### 生成内容\n\n### 生成内容\n\n### 生成内容\n\n### 生成内容\n\n### 生成内容\n\n### 生成内容\n\n### 生成内容\n\n### 生成内容\n\n### 生成内容\n\n### 生成内容\n\n### 生成内容\n\n### 生成内容\n\n### 生成内容\n\n### 生成内容\n\n### 生成内容\n\n### 生成内容\n\n### 生成内容\n\n### 生成内容\n\n### 生成内容\n\n### 生成内容\n\n### 生成内容\n\n### 生成内容\n\n### 生成内容\n\n### 生成内容\n\n### 生成内容\n\n### 生成内容\n\n### 生成内容\n\n### 生成内容\n\n### 生成内容\n\n### 生成内容\n\n### 生成内容\n\n### 生成内容\n\n### 生成内容\n\n### 生成内容` },
      outputFormat: { value: 'markdown', addEventListener: () => {} },
      formatPrompt: { value: '请使用 Markdown 格式，章节标题使用 H1。' },
      loadingState: document.getElementById('loading-state'),
      chapterTitleDisplay: document.getElementById('chapter-title-display'),
      contentArea: document.getElementById('content-area'),
      contentAreaContainer: document.getElementById('content-area-container'),
      readingArea: document.getElementById('reading-area'),
      wordCount: document.getElementById('word-count'),
      chapterInfo: document.getElementById('chapter-info'),
      paginationControls: document.getElementById('pagination-controls'),
      prevPageBtn: document.getElementById('prev-page'),
      nextPageBtn: document.getElementById('next-page'),
      pageInfo: document.getElementById('page-info'),
      prevChapterBtn: document.getElementById('prev-chapter'),
      nextChapterBtn: document.getElementById('next-chapter'),
      customPromptBtn: document.getElementById('custom-prompt-btn'),
      continueStoryBtn: document.getElementById('continue-story'),
      regenerateChapterBtn: document.getElementById('regenerate-chapter'),
      openSettingsBtn: document.getElementById('open-settings'),
      exportChapterBtn: document.getElementById('export-chapter'),
      exportAllChaptersBtn: document.getElementById('export-all-chapters'),
      settingsModal: document.getElementById('settings-modal'),
      closeSettingsBtn: document.getElementById('close-settings'),
      fontSizeSlider: document.getElementById('font-size-slider'),
      fontSizeValue: document.getElementById('font-size-value'),
      lineHeightSlider: document.getElementById('line-height-slider'),
      lineHeightValue: document.getElementById('line-height-value'),
      letterSpacingSlider: document.getElementById('letter-spacing-slider'),
      letterSpacingValue: document.getElementById('letter-spacing-value'),
      fontUpload: document.getElementById('font-upload'),
      dialogueBoldToggle: document.getElementById('dialogue-bold-toggle'),
      dialogueColorPicker: document.getElementById('dialogue-color-picker'),
      resetDialogueColorBtn: document.getElementById('reset-dialogue-color'),
      customPromptModal: document.getElementById('custom-prompt-modal'),
      closeCustomPromptBtn: document.getElementById('close-custom-prompt'),
      customPromptInput: document.getElementById('custom-prompt-input'),
      submitCustomPromptBtn: document.getElementById('submit-custom-prompt'),
      editChapterBtn: document.getElementById('edit-chapter'),
      editChapterModal: document.getElementById('edit-chapter-modal'),
      closeEditChapterBtn: document.getElementById('close-edit-chapter'),
      editChapterTitleInput: document.getElementById('edit-chapter-title'),
      editChapterContentArea: document.getElementById('edit-chapter-content'),
      deleteChapterBtn: document.getElementById('delete-chapter'),
      cancelEditBtn: document.getElementById('cancel-edit'),
      saveEditBtn: document.getElementById('save-edit'),
      openModelSettingsBtn: document.getElementById('open-model-settings'),
      openStoryPresetBtn: document.getElementById('open-story-preset'),
      modelSettingsModal: document.getElementById('model-settings-modal'),
      closeModelSettingsBtn: document.getElementById('close-model-settings'),
      storyPresetModal: document.getElementById('story-preset-modal'),
      closeStoryPresetBtn: document.getElementById('close-story-preset'),
    };
    
    // --- NEW: STATE PERSISTENCE FUNCTIONS ---
    const saveState = () => {
        const state = {
            story,
            currentChapterIndex,
            apiConfig: { type: elements.apiType.value, url: elements.apiUrl.value || 'https://generativelanguage.googleapis.com', key: elements.apiKey.value },
            settings: {
                model: elements.modelSelect.value,
                contextMemory: elements.contextMemorySlider.value,
                temperature: elements.temperatureSlider.value,
                presetText: elements.presetText.value,
                outputFormat: elements.outputFormat.value,
                formatPrompt: elements.formatPrompt.value,
                reading: {
                    fontSize: elements.fontSizeSlider.value,
                    lineHeight: elements.lineHeightSlider.value,
                    letterSpacing: elements.letterSpacingSlider.value,
                    dialogueBold: elements.dialogueBoldToggle.checked,
                    dialogueColor: elements.dialogueColorPicker.value,
                }
            }
        };
        localStorage.setItem('aiReaderState_v2', JSON.stringify(state));
    };

    const loadState = () => {
        const savedState = localStorage.getItem('aiReaderState_v2');
        if (!savedState) return;

        try {
            const state = JSON.parse(savedState);
            story = state.story || [];
            currentChapterIndex = state.currentChapterIndex || 0;

            if (state.apiConfig) {
                elements.apiType.value = state.apiConfig.type || 'openai';
                elements.apiUrl.value = state.apiConfig.url || 'https://cdn.generativelanguage.googleapis.com';
                elements.apiKey.value = state.apiConfig.key || '';
            }

            if (state.settings) {
                const s = state.settings;
                // We don't restore the model directly, as it needs API connection first.
                // We save the preference and apply it after connection.
                if (s.model) localStorage.setItem('aiReader_lastModel', s.model);

                elements.contextMemorySlider.value = s.contextMemory || 3;
                elements.memoryValue.textContent = `${s.contextMemory || 3}章`;

                elements.temperatureSlider.value = s.temperature || 0.7;
                elements.temperatureValue.textContent = parseFloat(s.temperature || 0.7).toFixed(1);
                
                elements.presetText.value = s.presetText || `### 故事设定\n\n### 人物设定\你\n### 世界观设定\穿书\n### 文风设定\穿书\n### 剧本设定\穿书\n### 内容格式设定\使用markdown格式\n### 生成规则\n\n### 生成内容\n\n### 生成内容\n\n### 生成内容\n\n### 生成内容\n\n### 生成内容\n\n### 生成内容\n\n### 生成内容\n\n### 生成内容\n\n### 生成内容\n\n### 生成内容\n\n### 生成内容\n\n### 生成内容\n\n### 生成内容\n\n### 生成内容\n\n### 生成内容\n\n### 生成内容\n\n### 生成内容\n\n### 生成内容\n\n### 生成内容\n\n### 生成内容\n\n### 生成内容\n\n### 生成内容\n\n### 生成内容\n\n### 生成内容\n\n### 生成内容\n\n### 生成内容\n\n### 生成内容\n\n### 生成内容\n\n### 生成内容\n\n### 生成内容\n\n### 生成内容\n\n### 生成内容\n\n### 生成内容\n\n### 生成内容\n\n### 生成内容\n\n### 生成内容`;
                elements.outputFormat.value = s.outputFormat || 'markdown';
                elements.formatPrompt.value = s.formatPrompt || '请使用 Markdown 格式，章节标题使用 H1，段落清晰。';
                
                if(s.reading) {
                    const r = s.reading;
                    elements.fontSizeSlider.value = r.fontSize || 18;
                    elements.lineHeightSlider.value = r.lineHeight || 1.75;
                    elements.letterSpacingSlider.value = r.letterSpacing || 0.025;
                    elements.dialogueBoldToggle.checked = r.dialogueBold || false;
                    elements.dialogueColorPicker.value = r.dialogueColor || '#334155';
                    applyReadingSettings(); // Apply loaded settings to the page
                }
            }
        } catch (error) {
            console.error("Failed to load state from localStorage:", error);
            localStorage.removeItem('aiReaderState_v2'); // Clear corrupted state
        }
    };
    
    // Helper to apply reading settings from sliders/inputs
    const applyReadingSettings = () => {
        const root = document.documentElement;
        const size = `${elements.fontSizeSlider.value}px`;
        root.style.setProperty('--reading-font-size', size);
        elements.fontSizeValue.textContent = size;

        const height = elements.lineHeightSlider.value;
        root.style.setProperty('--reading-line-height', height);
        elements.lineHeightValue.textContent = height;
        
        const spacing = `${elements.letterSpacingSlider.value}em`;
        root.style.setProperty('--reading-letter-spacing', spacing);
        elements.letterSpacingValue.textContent = spacing;

        root.style.setProperty('--dialogue-highlight-weight', elements.dialogueBoldToggle.checked ? 'bold' : 'normal');
        
        const defaultColor = getComputedStyle(root).getPropertyValue(
            document.documentElement.classList.contains('dark') ? '--reading-text-color' : '--reading-text-color'
        ).trim();
        const chosenColor = elements.dialogueColorPicker.value;
        // Only set dialogue color if it's different from the default text color to avoid overriding everything
        root.style.setProperty('--dialogue-highlight-color', chosenColor);
    };

    // --- RENDER & UPDATE FUNCTIONS ---
    const highlightDialogue = (text) => {
      if (!text) return '';
      const dialogueRegex = /(“[^”]+”|‘[^’]+’|"[^"]+"|\'[^\']+\'|「[^」]+」|『[^』]+』)/g;
      return text.replace(dialogueRegex, (match) => `<span class="dialogue-highlight">${match}</span>`);
    };
    
    const escapeHtml = (unsafe) => {
        if (!unsafe) return '';
        return unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
    }

    const paginateChapterContent = (fullHtmlContent, limit = 1500) => {
      if (!fullHtmlContent || fullHtmlContent.trim() === '') return [''];
      const pages = [];
      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = fullHtmlContent;
      const nodes = Array.from(tempDiv.childNodes);
      if (nodes.length === 0) return [fullHtmlContent];
      let currentPageHtml = '';
      let currentPageCharCount = 0;
      for (const node of nodes) {
          const nodeText = node.textContent || "";
          const nodeHtml = node.outerHTML || nodeText;
          if (currentPageHtml !== '' && currentPageCharCount + nodeText.length > limit) {
              pages.push(currentPageHtml);
              currentPageHtml = nodeHtml;
              currentPageCharCount = nodeText.length;
          } else {
              currentPageHtml += nodeHtml;
              currentPageCharCount += nodeText.length;
          }
      }
      if (currentPageHtml !== '') pages.push(currentPageHtml);
      return pages.length > 0 ? pages : [''];
    };

    const renderCurrentPage = () => {
        if (chapterPages.length === 0) return;
        elements.contentArea.innerHTML = chapterPages[currentPageIndex];
        updatePaginationNav();
    };

    const renderChapter = (index) => {
      if (index < 0 || index >= story.length) return;
      elements.contentAreaContainer.classList.remove('hidden');
      currentChapterIndex = index;
      const chapter = story[index];
      const outputFormat = elements.outputFormat.value;
      let contentHtml;
      if (outputFormat === 'markdown') {
          contentHtml = mdConverter.makeHtml(chapter.content);
          contentHtml = highlightDialogue(contentHtml);
      } else if (outputFormat === 'html') {
          contentHtml = chapter.content; // No dialogue highlighting for HTML
      } else { // text
          let safeText = escapeHtml(chapter.content);
          safeText = highlightDialogue(safeText);
          contentHtml = safeText.replace(/\n/g, '<br>');
      }
      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = contentHtml;
      const h1 = tempDiv.querySelector('h1');
      if (h1) {
          chapter.title = h1.textContent;
          h1.remove();
          contentHtml = tempDiv.innerHTML;
      }
      elements.chapterTitleDisplay.textContent = chapter.title;
      // Increased character limit for pagination
      chapterPages = paginateChapterContent(contentHtml, 2500); 
      currentPageIndex = 0;
      renderCurrentPage();
      updateWordCount();
      updateChapterNav();
      elements.readingArea.scrollTop = 0;
      saveState();
    };

    const updateWordCount = () => {
        if (story.length === 0 || !story[currentChapterIndex]) {
            elements.wordCount.textContent = '0';
            return;
        }
        const fullText = story[currentChapterIndex].content || '';
        const matches = fullText.match(/[\u4e00-\u9fa5a-zA-Z0-9]+/g);
        elements.wordCount.textContent = matches ? matches.join('').length : 0;
    };

    const updateChapterNav = () => {
      const hasStory = story.length > 0;
      elements.chapterInfo.textContent = hasStory ? `第 ${currentChapterIndex + 1} / ${story.length} 章` : '无内容';
      elements.prevChapterBtn.disabled = !hasStory || currentChapterIndex === 0;
      elements.nextChapterBtn.disabled = !hasStory || currentChapterIndex === story.length - 1;
      elements.regenerateChapterBtn.disabled = !hasStory;
      elements.exportChapterBtn.disabled = !hasStory;
      elements.exportAllChaptersBtn.disabled = !hasStory;
      elements.editChapterBtn.disabled = !hasStory;
    };

    const updatePaginationNav = () => {
      if (chapterPages.length > 1) {
          elements.paginationControls.classList.remove('hidden');
          elements.pageInfo.textContent = `第 ${currentPageIndex + 1} / ${chapterPages.length} 页`;
          elements.prevPageBtn.disabled = currentPageIndex === 0;
          elements.nextPageBtn.disabled = currentPageIndex === chapterPages.length - 1;
      } else {
          elements.paginationControls.classList.add('hidden');
      }
    };

    // 进度条控制
    let progressInterval;
    const showLoading = (isLoading) => {
        elements.loadingState.classList.toggle('hidden', !isLoading);
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');
        
        if (isLoading) {
            // 重置进度条
            progressBar.style.width = '0%';
            progressText.textContent = '准备中...';
            
            // 模拟进度增加
            let progress = 0;
            progressInterval = setInterval(() => {
                // 缓慢增加到95%，留5%给最终完成
                if (progress < 95) {
                    progress += Math.random() * 3;
                    progress = Math.min(progress, 95);
                    progressBar.style.width = `${progress}%`;
                    
                    // 更新进度文本
                    if (progress < 20) {
                        progressText.textContent = '构思情节中...';
                    } else if (progress < 40) {
                        progressText.textContent = '设计人物对话...';
                    } else if (progress < 60) {
                        progressText.textContent = '丰富场景描写...';
                    } else if (progress < 80) {
                        progressText.textContent = '完善故事细节...';
                    } else {
                        progressText.textContent = '最终润色中...';
                    }
                }
            }, 300);
        } else {
            // 停止进度模拟
            clearInterval(progressInterval);
            // 完成进度
            progressBar.style.width = '100%';
            progressText.textContent = '生成完成!';
            // 短暂延迟后隐藏加载状态
            setTimeout(() => {
                elements.loadingState.classList.add('hidden');
            }, 500);
        }
    };
    
    // --- NEW: WELCOME MESSAGE FUNCTION ---
    const renderWelcomeMessage = () => {
        elements.contentAreaContainer.classList.add('hidden');
        const existingWelcome = document.getElementById('welcome-message');
        if (existingWelcome) existingWelcome.remove();
        elements.readingArea.innerHTML += `
            <div id="welcome-message" class="text-center p-10 flex flex-col items-center justify-center h-full">
                <i class="fa fa-magic text-6xl text-gray-300 dark:text-gray-600 mb-4"></i>
                <h2 class="text-2xl font-bold text-gray-700 dark:text-gray-300 mb-2">欢迎使用 爱小说</h2>
                <div class="flex flex-wrap justify-center gap-2 text-sm text-gray-400 dark:text-gray-500">
                    <p class="flex items-center"><i class="fa fa-cogs mr-1"></i>模型设置</p>
                    <p class="flex items-center"><i class="fa fa-file-text-o mr-1"></i>故事设定</p>
                    <p class="flex items-center"><i class="fa fa-play mr-1"></i>开始生成</p>
                    <p class="flex items-center"><i class="fa fa-magic mr-1"></i>自定情节</p>
                    <p class="flex items-center"><i class="fa fa-refresh mr-1"></i>重新生成</p>
                    <p class="flex items-center"><i class="fa fa-edit mr-1"></i>编辑章节</p>
                    <p class="flex items-center"><i class="fa fa-sliders mr-1"></i>阅读设置</p>
                    <p class="flex items-center"><i class="fa fa-download mr-1"></i>导出章节</p>
                    <p class="flex items-center"><i class="fa fa-save mr-1"></i>导出全部</p>
                </div>
            </div>
        `;
        updateWordCount();
        updateChapterNav();
        updatePaginationNav();
    };

    // --- API & GENERATION LOGIC ---
    async function fetchFromApi(endpoint, options) {
        const response = await fetch(endpoint, options);
        if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            const errorMessage = errorData?.error?.message || `HTTP error! status: ${response.status}`;
            throw new Error(errorMessage);
        }
        return response.json();
    }

    async function generateChapter(prompt, isRegeneration = false) {
        if (!apiConfig.isConnected || !elements.modelSelect.value) {
            alert('请先点击顶部齿轮图标配置AI模型！');
            return;
        }
        showLoading(true);
        const welcomeMsg = document.getElementById('welcome-message');
        if (welcomeMsg) welcomeMsg.remove();
        parseApiKeys();
        const currentKey = getCurrentApiKey();

        try {
            const contextMemory = parseInt(elements.contextMemorySlider.value, 10);
            const storyPreset = elements.presetText.value;
            const formatInstructions = elements.formatPrompt.value;
            const apiType = elements.apiType.value;
            const modelId = elements.modelSelect.value;
            let systemPrompt, messages, payload, endpoint, headers;
            if (apiType === 'openai') {
                systemPrompt = `你是一位才华横溢的小说家。请根据以下设定和要求，继续创作故事。\n\n### 故事预设\n${storyPreset}\n\n### 输出格式要求\n${formatInstructions}`;
                messages = [{ role: 'system', content: systemPrompt }];
                const storyForContext = isRegeneration ? story.slice(0, currentChapterIndex) : story;
                if (contextMemory > 0 && storyForContext.length > 0) {
                  const startIndex = Math.max(0, storyForContext.length - contextMemory);
                  const contextChapters = storyForContext.slice(startIndex);
                  let contextPrompt = "这是故事的背景和之前的章节内容，请在此基础上继续：\n\n";
                  contextChapters.forEach(chap => {
                      contextPrompt += `# ${chap.title}\n${chap.content}\n\n`;
                  });
                  messages.push({ role: 'user', content: contextPrompt });
                  messages.push({ role: 'assistant', content: "好的，已了解背景和之前的章节。请告诉我接下来要创作什么。" });
                }
                messages.push({ role: 'user', content: `### 当前任务\n${prompt}` });
                payload = {
                    model: modelId,
                    messages: messages,
                    temperature: parseFloat(elements.temperatureSlider.value),
                };
                endpoint = apiConfig.url;
                headers = { 'Content-Type': 'application/json', 'Authorization': `Bearer ${currentKey}` };
            } else if (apiType === 'gemini') {
                // Gemini: 只支持 user role，内容在 parts 里
                let contextText = '';
                const storyForContext = isRegeneration ? story.slice(0, currentChapterIndex) : story;
                if (contextMemory > 0 && storyForContext.length > 0) {
                  const startIndex = Math.max(0, storyForContext.length - contextMemory);
                  const contextChapters = storyForContext.slice(startIndex);
                  contextText += "这是故事的背景和之前的章节内容，请在此基础上继续：\n\n";
                  contextChapters.forEach(chap => {
                      contextText += `# ${chap.title}\n${chap.content}\n\n`;
                  });
                }
                const fullPrompt = `你是一位才华横溢的小说家。请根据以下设定和要求，继续创作故事。\n\n### 故事预设\n${storyPreset}\n\n### 输出格式要求\n${formatInstructions}\n\n${contextText}\n### 当前任务\n${prompt}`;
                payload = {
                    contents: [{ role: 'user', parts: [{ text: fullPrompt }] }],
                };
                endpoint = `https://generativelanguage.googleapis.com/v1beta/models/${modelId}:generateContent?key=${currentKey}`;
                headers = { 'Content-Type': 'application/json' };
            }
            const data = await fetchFromApi(endpoint, {
                method: 'POST',
                headers: headers,
                body: JSON.stringify(payload)
            });
            let newContent;
            if (apiType === 'openai') {
                newContent = data.choices[0]?.message?.content?.trim();
            } else if (apiType === 'gemini') {
                newContent = data.candidates?.[0]?.content?.parts?.[0]?.text?.trim();
            }
            if (!newContent) throw new Error('API返回的内容为空。');
            if (isRegeneration) {
                story[currentChapterIndex].content = newContent;
                if (!story[currentChapterIndex].title.startsWith("第")) {
                    story[currentChapterIndex].title = `第 ${currentChapterIndex + 1} 章`;
                }
                renderChapter(currentChapterIndex);
            } else {
                story.push({ title: `第 ${story.length + 1} 章`, content: newContent, customPrompt: prompt });
                renderChapter(story.length - 1);
            }
            // `renderChapter` already calls saveState
        } catch (error) {
            console.error('小说生成失败:', error);
            alert(`小说生成失败：${error.message}`);
        } finally {
            showLoading(false);
            nextApiKey();
        }
    }
    
    // --- EVENT LISTENERS ---
    elements.connectApiBtn.addEventListener('click', async () => {
        parseApiKeys();
        const currentKey = getCurrentApiKey();
        const apiType = elements.apiType.value;
        const urlInput = elements.apiUrl.value.trim() || 'https://generativelanguage.googleapis.com';
        const keyInput = currentKey;
        if (!keyInput) {
            alert('请输入API密钥。');
            return;
        }
        let baseUrl = urlInput.replace(/\/+$/, '').replace(/\/v1\/.*$/, '');
        let modelsUrl, completionsUrl;
        if (apiType === 'openai') {
            modelsUrl = `${baseUrl}/v1/models`;
            completionsUrl = `${baseUrl}/v1/chat/completions`;
        } else if (apiType === 'gemini') {
            modelsUrl = `https://generativelanguage.googleapis.com/v1beta/models?key=${keyInput}`;
            completionsUrl = null; // Gemini每次用不同的endpoint
        }

        elements.connectApiBtn.disabled = true;
        elements.connectApiBtn.innerHTML = '<i class="fa fa-spinner fa-spin mr-2"></i>连接中...';
        elements.apiStatus.classList.remove('hidden', 'bg-green-100', 'text-green-800', 'bg-red-100', 'text-red-800', 'dark:bg-green-900/50', 'dark:text-green-300', 'dark:bg-red-900/50', 'dark:text-red-300', 'bg-yellow-100', 'text-yellow-800', 'dark:bg-yellow-900/50', 'dark:text-yellow-300');
        elements.apiStatus.textContent = '';
        
        try {
            let data, models;
            if (apiType === 'openai') {
                data = await fetchFromApi(modelsUrl, { headers: { 'Authorization': `Bearer ${currentKey}` } });
                models = data.data || [];
            } else if (apiType === 'gemini') {
                data = await fetchFromApi(modelsUrl, {});
                models = data.models || [];
            }
            elements.modelSelect.innerHTML = '';
            if (models.length > 0) {
                models.sort((a, b) => (a.id || a.name).localeCompare(b.id || b.name)).forEach(model => {
                    // Gemini: id/name 字段兼容
                    let modelId = model.id || model.name;
                    if (!modelId) return;
                    // OpenAI: 过滤 embed/vision，Gemini不过滤
                    if (apiType === 'openai' && (modelId.includes('embed') || modelId.includes('vision'))) return;
                    // 修正：去除 models/ 前缀
                    if (apiType === 'gemini' && modelId.startsWith('models/')) {
                        modelId = modelId.replace('models/', '');
                    }
                    const option = document.createElement('option');
                    option.value = modelId;
                    option.textContent = modelId;
                    elements.modelSelect.appendChild(option);
                });
                const lastModel = localStorage.getItem('aiReader_lastModel');
                if (lastModel && elements.modelSelect.querySelector(`option[value="${lastModel}"]`)) {
                    elements.modelSelect.value = lastModel;
                }
                elements.modelSelect.disabled = false;
                apiConfig = { type: apiType, url: completionsUrl || urlInput, key: currentKey, isConnected: true };
                elements.apiStatus.textContent = `模型连接成功！已加载 ${elements.modelSelect.options.length} 个可用模型。`;
                elements.apiStatus.classList.add('bg-green-100', 'text-green-800', 'dark:bg-green-900/50', 'dark:text-green-300');
                elements.connectApiBtn.innerHTML = '<i class="fa fa-check mr-2"></i>已连接';
                saveState();
                nextApiKey();
            } else {
                throw new Error('API返回的模型列表为空。');
            }
        } catch (error) {
            apiConfig.isConnected = false;
            elements.modelSelect.innerHTML = '<option value="">请先连接API</option>';
            elements.modelSelect.disabled = true;
            elements.apiStatus.textContent = `模型连接失败: ${error.message}`;
            elements.apiStatus.classList.add('bg-red-100', 'text-red-800', 'dark:bg-red-900/50', 'dark:text-red-300');
            elements.connectApiBtn.disabled = false;
            elements.connectApiBtn.innerHTML = '<i class="fa fa-connectdevelop mr-2"></i>连接模型';
        }
    });
    
    elements.themeToggle.addEventListener('click', () => {
      document.documentElement.classList.toggle('dark');
      const isDark = document.documentElement.classList.contains('dark');
      const icon = elements.themeToggle.querySelector('i');
      icon.classList.toggle('fa-sun-o', isDark);
      icon.classList.toggle('fa-moon-o', !isDark);
      localStorage.setItem('theme', isDark ? 'dark' : 'light');
      // Update dialogue color to match the new theme's default text color
      const defaultTextColor = getComputedStyle(document.documentElement).getPropertyValue('--reading-text-color');
      elements.dialogueColorPicker.value = defaultTextColor.trim();
      applyReadingSettings();
      saveState();
    });

    ['input', 'change'].forEach(evt => {
        elements.apiUrl.addEventListener(evt, saveState);
        elements.apiKey.addEventListener(evt, saveState);
        elements.modelSelect.addEventListener(evt, saveState);
        elements.contextMemorySlider.addEventListener(evt, saveState);
        elements.temperatureSlider.addEventListener(evt, saveState);
        // 移除对不存在元素的事件监听
        // elements.presetText.addEventListener(evt, saveState);
        // elements.outputFormat.addEventListener(evt, saveState);
        // elements.formatPrompt.addEventListener(evt, saveState);
        elements.fontSizeSlider.addEventListener(evt, () => { applyReadingSettings(); saveState(); });
        elements.lineHeightSlider.addEventListener(evt, () => { applyReadingSettings(); saveState(); });
        elements.letterSpacingSlider.addEventListener(evt, () => { applyReadingSettings(); saveState(); });
        elements.dialogueBoldToggle.addEventListener(evt, () => { applyReadingSettings(); saveState(); });
        elements.dialogueColorPicker.addEventListener(evt, () => { applyReadingSettings(); saveState(); });
    });

    elements.prevChapterBtn.addEventListener('click', () => { if (currentChapterIndex > 0) renderChapter(currentChapterIndex - 1) });
    elements.nextChapterBtn.addEventListener('click', () => { if (currentChapterIndex < story.length - 1) renderChapter(currentChapterIndex + 1) });
    elements.prevPageBtn.addEventListener('click', () => { if (currentPageIndex > 0) { currentPageIndex--; renderCurrentPage(); } });
    elements.nextPageBtn.addEventListener('click', () => { if (currentPageIndex < chapterPages.length - 1) { currentPageIndex++; renderCurrentPage(); } });
    elements.continueStoryBtn.addEventListener('click', () => generateChapter("请自然地延续上一章的结尾，创作下一章的内容。"));
    elements.regenerateChapterBtn.addEventListener('click', () => {
        const chapter = story[currentChapterIndex];
        const prompt = chapter.customPrompt || "请根据相同的上下文，重新生成当前这一章的内容，可以尝试不同的情节走向或描写方式。";
        generateChapter(prompt, true);
    });
    elements.customPromptBtn.addEventListener('click', () => elements.customPromptModal.classList.remove('hidden'));
    elements.closeCustomPromptBtn.addEventListener('click', () => elements.customPromptModal.classList.add('hidden'));
    elements.submitCustomPromptBtn.addEventListener('click', () => {
        const prompt = elements.customPromptInput.value;
        if (prompt.trim()) {
            generateChapter(prompt);
            elements.customPromptModal.classList.add('hidden');
            elements.customPromptInput.value = '';
        }
    });
    elements.openSettingsBtn.addEventListener('click', () => elements.settingsModal.classList.remove('hidden'));
    elements.closeSettingsBtn.addEventListener('click', () => elements.settingsModal.classList.add('hidden'));
    elements.editChapterBtn.addEventListener('click', () => {
        const chapter = story[currentChapterIndex];
        elements.editChapterModal.classList.remove('hidden');
        elements.editChapterTitleInput.value = chapter.title;
        elements.editChapterContentArea.value = chapter.content;
    });
    elements.closeEditChapterBtn.addEventListener('click', () => {
        elements.editChapterModal.classList.add('hidden');
    });
    elements.saveEditBtn.addEventListener('click', () => {
        const chapter = story[currentChapterIndex];
        const newTitle = elements.editChapterTitleInput.value.trim();
        const newContent = elements.editChapterContentArea.value.trim();
        
        if (newTitle && newContent) {
            chapter.title = newTitle;
            chapter.content = newContent;
            renderChapter(currentChapterIndex);
            saveState();
        } else {
            alert('章节标题和内容不能为空！');
        }
        elements.editChapterModal.classList.add('hidden');
    });
    elements.deleteChapterBtn.addEventListener('click', () => {
        if (confirm('确定要删除此章节吗？这将无法恢复。')) {
            story.splice(currentChapterIndex, 1);
            if (story.length === 0) {
                renderWelcomeMessage();
            } else {
                currentChapterIndex = Math.min(currentChapterIndex, story.length - 1);
                renderChapter(currentChapterIndex);
            }
            saveState();
            elements.editChapterModal.classList.add('hidden');
        }
    });
    elements.cancelEditBtn.addEventListener('click', () => {
        elements.editChapterModal.classList.add('hidden');
    });

    // --- 新增模态框事件监听器 ---
    elements.openModelSettingsBtn.addEventListener('click', () => {
        elements.modelSettingsModal.classList.remove('hidden');
    });
    
    elements.closeModelSettingsBtn.addEventListener('click', () => {
        elements.modelSettingsModal.classList.add('hidden');
    });
    
    elements.openStoryPresetBtn.addEventListener('click', () => {
        elements.storyPresetModal.classList.remove('hidden');
    });
    
    elements.closeStoryPresetBtn.addEventListener('click', () => {
        elements.storyPresetModal.classList.add('hidden');
    });

    // --- 原有功能事件监听器 ---
    elements.toggleKeyBtn.addEventListener('click', () => {
      const icon = elements.toggleKeyBtn.querySelector('i');
      elements.apiKey.type = (elements.apiKey.type === 'password') ? 'text' : 'password';
      icon.classList.toggle('fa-eye');
      icon.classList.toggle('fa-eye-slash');
    });
    
    elements.contextMemorySlider.addEventListener('input', (e) => elements.memoryValue.textContent = `${e.target.value}章`);
    elements.temperatureSlider.addEventListener('input', (e) => elements.temperatureValue.textContent = parseFloat(e.target.value).toFixed(1));
    
    elements.presetUpload.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file && file.type === "text/plain") {
        const reader = new FileReader();
        reader.onload = (event) => { elements.presetText.value = event.target.result; saveState(); };
        reader.readAsText(file);
      }
    });
    
    elements.outputFormat.addEventListener('change', () => {
        if (story.length > 0) renderChapter(currentChapterIndex)
    });

    elements.fontUpload.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (event) => {
                const fontDataUrl = event.target.result;
                const fontName = 'CustomReadingFont';
                const newStyle = document.createElement('style');
                newStyle.textContent = `@font-face { font-family: '${fontName}'; src: url('${fontDataUrl}'); }`;
                document.head.appendChild(newStyle);
                document.documentElement.style.setProperty('--reading-font', `'${fontName}'`);
            };
            reader.readAsDataURL(file);
        }
    });

    elements.resetDialogueColorBtn.addEventListener('click', () => {
        const defaultColor = getComputedStyle(document.documentElement).getPropertyValue('--reading-text-color');
        elements.dialogueColorPicker.value = defaultColor.trim();
        applyReadingSettings();
        saveState();
    });

    // --- FIXED: File Export with UTF-8 BOM ---
    function downloadAsTxt(filename, text) {
      const bom = '\uFEFF';
      const blob = new Blob([bom + text], { type: 'text/plain;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }
    elements.exportChapterBtn.addEventListener('click', () => {
      const chapter = story[currentChapterIndex];
      const filename = `${chapter.title.replace(/[\/\\?%*:|"<>]/g, '_') || '当前章节'}.txt`;
      downloadAsTxt(filename, chapter.content);
    });
    elements.exportAllChaptersBtn.addEventListener('click', () => {
      let fullStoryText = '';
      story.forEach((chapter, index) => {
        fullStoryText += `# ${chapter.title}\n\n${chapter.content}\n\n${index < story.length - 1 ? '--------------------\n\n' : ''}`;
      });
      downloadAsTxt('完整故事.txt', fullStoryText);
    });

    // --- 故事预设数据结构 ---
    const presetData = {
      character: [], // {id, name, desc}
      player: [],    // {id, name, desc} - 玩家人设
      world: [],     // {id, name, desc}
      style: [],     // {id, name, desc}
      script: [],    // {id, name, desc}
      format: [      // {id, name, desc} - 内容格式
        {
          id: 'default-markdown',
          name: 'markdown格式',
          desc: '使用markdown格式编写，包含H1章节标题',
          default: true
        }
      ],
      selectedFormat: 'default-markdown'  // 默认选中项
    };
    // 预设本地存储key
    const PRESET_KEY = 'aiNovelPresets_v1';
    // 加载预设
    function loadPresets() {
      const raw = localStorage.getItem(PRESET_KEY);
      if (raw) {
        try {
          const data = JSON.parse(raw);
          ['character','player','world','style','script','format'].forEach(k=>{
            presetData[k] = Array.isArray(data[k]) ? data[k] : [];
          });
        } catch(e) {}
      }
    }
    // 保存预设
    function savePresets() {
      localStorage.setItem(PRESET_KEY, JSON.stringify(presetData));
    }
    // 生成唯一id
    function uuid() { return 'id-' + Math.random().toString(36).slice(2,10) + Date.now(); }

    // 选中的预设项
    const selectedPresets = {
      character: [],
      player: [],
      world: [],
      style: [],
      script: [],
      format: []
    };
    
    // 保存选中的预设状态
    function saveSelectedPresets() {
      localStorage.setItem('aiNovelSelectedPresets', JSON.stringify(selectedPresets));
    }
    
    // 加载选中的预设状态
    function loadSelectedPresets() {
      const savedPresets = localStorage.getItem('aiNovelSelectedPresets');
      if (savedPresets) {
        try {
          const data = JSON.parse(savedPresets);
          ['character', 'player', 'world', 'style', 'script', 'format'].forEach(k => {
            selectedPresets[k] = Array.isArray(data[k]) ? data[k] : [];
          });
        } catch(e) {
          console.error('加载选中预设状态失败:', e);
        }
      }
    }
    
    // 渲染tab内容
    function renderPresetTab(tab) {
      const container = document.getElementById('preset-tab-content');
      container.innerHTML = '';
      const list = presetData[tab];
      const tabName = {character:'人设',player:'玩家人设',world:'世界观',style:'文风',script:'剧本',format:'内容格式'}[tab];
      
      // 顶部操作区
      const topActions = document.createElement('div');
      topActions.className = 'flex justify-between items-center mb-3';
      
      // 新增按钮
      const addBtn = document.createElement('button');
      addBtn.className = 'px-3 py-1 bg-primary text-white rounded hover:bg-primary/90 text-sm';
      addBtn.textContent = `新增${tabName}`;
      addBtn.onclick = ()=>showPresetEdit(tab);
      
      // 生成故事按钮
      const generateBtn = document.createElement('button');
      // generateBtn.className = 'px-3 py-1 bg-secondary text-white rounded hover:bg-secondary/90 text-sm flex items-center';
      // generateBtn.innerHTML = '<i class="fa fa-magic mr-1"></i>生成故事';
      generateBtn.onclick = generateStoryFromPresets;
      
      topActions.appendChild(addBtn);
      topActions.appendChild(generateBtn);
      container.appendChild(topActions);
      
      // 列表
      const ul = document.createElement('ul');
      ul.className = 'space-y-2';
      list.forEach(item=>{
        const li = document.createElement('li');
        const isSelected = selectedPresets[tab].includes(item.id);
        li.className = `flex items-center justify-between ${isSelected ? 'bg-primary/10 border border-primary/30' : 'bg-gray-50 dark:bg-slate-700'} rounded px-3 py-2 cursor-pointer transition-colors`;
        li.innerHTML = `
          <div class="flex items-center">
            <div class="mr-2">
              <input type="checkbox" class="preset-checkbox h-4 w-4 rounded border-gray-300 text-primary focus:ring-primary" 
                data-tab="${tab}" data-id="${item.id}" ${isSelected ? 'checked' : ''}>
            </div>
            <div class="flex-grow">
              <div class='font-semibold'>${item.name}</div>
              <div class='text-xs text-gray-400 mt-1 hidden preset-desc'>${item.desc||''}</div>
            </div>
            <div class="ml-2">
              <button class="toggle-desc p-1 rounded hover:bg-gray-200 dark:hover:bg-slate-600" title="显示/隐藏详情">
                <i class="fa fa-chevron-down"></i>
              </button>
            </div>
          </div>
        `;
        
        const btns = document.createElement('div');
        btns.className = 'flex space-x-1';
        const editBtn = document.createElement('button');
        editBtn.className = 'p-1 rounded hover:bg-primary/10';
        editBtn.innerHTML = '<i class="fa fa-edit"></i>';
        editBtn.onclick = (e)=>{
          e.stopPropagation();
          showPresetEdit(tab, item);
        };
        const delBtn = document.createElement('button');
        delBtn.className = 'p-1 rounded hover:bg-red-100';
        delBtn.innerHTML = '<i class="fa fa-trash"></i>';
        delBtn.onclick = (e)=>{ 
          e.stopPropagation();
          if(confirm('确定删除？')){ 
            // 如果删除的是已选中的项，也从选中列表中移除
            if(selectedPresets[tab].includes(item.id)) {
              selectedPresets[tab] = selectedPresets[tab].filter(id => id !== item.id);
            }
            presetData[tab]=list.filter(i=>i.id!==item.id); 
            savePresets(); 
            renderPresetTab(tab);
          } 
        };
        btns.appendChild(editBtn); 
        btns.appendChild(delBtn);
        li.appendChild(btns);
        
        // 添加展开/折叠按钮的点击事件
        const toggleBtn = li.querySelector('.toggle-desc');
        toggleBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          const descElem = li.querySelector('.preset-desc');
          descElem.classList.toggle('hidden');
          const icon = toggleBtn.querySelector('i');
          icon.classList.toggle('fa-chevron-down');
          icon.classList.toggle('fa-chevron-up');
        });
        
        // 点击整行切换选中状态
        li.addEventListener('click', (e) => {
          if(e.target.closest('button')) return; // 如果点击的是按钮，不处理
          
          const checkbox = li.querySelector('.preset-checkbox');
          checkbox.checked = !checkbox.checked;
          
          // 更新选中状态
          if(checkbox.checked) {
            if(!selectedPresets[tab].includes(item.id)) {
              selectedPresets[tab].push(item.id);
            }
          } else {
            selectedPresets[tab] = selectedPresets[tab].filter(id => id !== item.id);
          }
          
          // 更新样式
          li.classList.toggle('bg-primary/10', checkbox.checked);
          li.classList.toggle('border', checkbox.checked);
          li.classList.toggle('border-primary/30', checkbox.checked);
          li.classList.toggle('bg-gray-50', !checkbox.checked);
          li.classList.toggle('dark:bg-slate-700', !checkbox.checked);
          
          // 更新总览区域
          updateSelectedPresetsSummary();
        });
        
        // 复选框事件
        li.querySelector('.preset-checkbox').addEventListener('change', (e) => {
          e.stopPropagation();
          const tabName = e.target.dataset.tab;
          const itemId = e.target.dataset.id;
          
          if(e.target.checked) {
            if(!selectedPresets[tabName].includes(itemId)) {
              selectedPresets[tabName].push(itemId);
            }
          } else {
            selectedPresets[tabName] = selectedPresets[tabName].filter(id => id !== itemId);
          }
          
          // 更新样式
          li.classList.toggle('bg-primary/10', e.target.checked);
          li.classList.toggle('border', e.target.checked);
          li.classList.toggle('border-primary/30', e.target.checked);
          li.classList.toggle('bg-gray-50', !e.target.checked);
          li.classList.toggle('dark:bg-slate-700', !e.target.checked);
          
          // 更新总览区域
          updateSelectedPresetsSummary();
        });
        
        ul.appendChild(li);
      });
      container.appendChild(ul);
      
      // 如果列表为空，显示提示
      if(list.length === 0) {
        const emptyMsg = document.createElement('div');
        emptyMsg.className = 'text-center text-gray-500 py-4';
        emptyMsg.textContent = `暂无${tabName}，请点击上方按钮添加`;
        container.appendChild(emptyMsg);
      }
      
      // 底部区域 - 显示已选择的项目数量
      const selectedCount = selectedPresets[tab].length;
      if(selectedCount > 0) {
        const selectedInfo = document.createElement('div');
        selectedInfo.className = 'mt-4 text-sm text-primary';
        selectedInfo.textContent = `已选择 ${selectedCount} 个${tabName}`;
        container.appendChild(selectedInfo);
      }
    }
    
    // 更新已选择项目的总览区域
    function updateSelectedPresetsSummary() {
      const summaryContainer = document.getElementById('selected-presets-summary');
      const tagsContainer = document.getElementById('selected-presets-tags');
      
      // 获取所有已选择的项目
      const allSelected = [];
      for(const tab in selectedPresets) {
        selectedPresets[tab].forEach(id => {
          const item = presetData[tab].find(i => i.id === id);
          if(item) {
            allSelected.push({
              id: item.id,
              name: item.name,
              tab: tab,
              tabName: {character:'人设',player:'玩家人设',world:'世界观',style:'文风',script:'剧本',format:'内容格式'}[tab]
            });
          }
        });
      }
      
      // 如果没有选择任何项目，隐藏总览区域
      if(allSelected.length === 0) {
        summaryContainer.classList.add('hidden');
        return;
      }
      
      // 显示总览区域
      summaryContainer.classList.remove('hidden');
      
      // 清空标签容器
      tagsContainer.innerHTML = '';
      
      // 添加标签
      allSelected.forEach(item => {
        const tag = document.createElement('div');
        tag.className = 'px-2 py-1 bg-primary/10 text-primary text-xs rounded-full flex items-center';
        tag.innerHTML = `
          <span class="mr-1">${item.tabName}:</span>
          <span>${item.name}</span>
          <button class="ml-1 hover:text-red-500" data-tab="${item.tab}" data-id="${item.id}">
            <i class="fa fa-times-circle"></i>
          </button>
        `;
        
        // 添加删除按钮的点击事件
        tag.querySelector('button').addEventListener('click', (e) => {
          const tab = e.currentTarget.dataset.tab;
          const id = e.currentTarget.dataset.id;
          
          // 从选中列表中移除
          selectedPresets[tab] = selectedPresets[tab].filter(itemId => itemId !== id);
          
          // 更新当前标签页
          renderPresetTab(currentPresetTab);
          
          // 更新总览区域
          updateSelectedPresetsSummary();
        });
        
        tagsContainer.appendChild(tag);
      });
    }
    
    // 清空所有选择
    function clearAllPresets() {
      for(const tab in selectedPresets) {
        selectedPresets[tab] = [];
      }
      
      // 更新当前标签页
      renderPresetTab(currentPresetTab);
      
      // 更新总览区域
      updateSelectedPresetsSummary();
    }
    
    // 根据选择的预设生成故事
    function generateStoryFromPresets() {
      // 检查是否有选择
      const hasSelection = Object.values(selectedPresets).some(arr => arr.length > 0);
      if(!hasSelection) {
        alert('请至少选择一项预设');
        return;
      }
      
      // 生成prompt
      const prompt = generatePromptFromPresets();
      
      // 关闭预设模态框
      elements.storyPresetModal.classList.add('hidden');
      
      // 生成故事
      generateChapter(prompt);
    }
    
    // 更新选择的预设总览
    function updateSelectedPresetsSummary() {
      const summaryElement = document.getElementById('selected-presets-summary');
      if (!summaryElement) return;
      
      // 统计各类预设的选择数量
      const counts = {
        character: selectedPresets.character.length,
        player: selectedPresets.player.length,
        world: selectedPresets.world.length,
        script: selectedPresets.script.length,
        style: selectedPresets.style.length,
        format: selectedPresets.format.length
      };
      
      const totalCount = Object.values(counts).reduce((sum, count) => sum + count, 0);
      
      // 更新总览内容
      if (totalCount === 0) {
        summaryElement.innerHTML = '<p class="text-gray-500">尚未选择任何预设</p>';
        document.getElementById('generate-story-btn').classList.add('hidden');
      } else {
        let summaryHTML = '<p class="font-medium mb-2">已选择的预设：</p><ul class="text-sm space-y-1">';
        
        if (counts.character > 0) {
          summaryHTML += `<li>角色：${counts.character} 个</li>`;
        }
        
        if (counts.player > 0) {
          summaryHTML += `<li>玩家人设：${counts.player} 个</li>`;
        }
        
        if (counts.world > 0) {
          summaryHTML += `<li>世界观：${counts.world} 个</li>`;
        }
        
        if (counts.script > 0) {
          summaryHTML += `<li>剧情：${counts.script} 个</li>`;
        }
        
        if (counts.style > 0) {
          summaryHTML += `<li>文风：${counts.style} 个</li>`;
        }
        
        if (counts.format > 0) {
          summaryHTML += `<li>内容格式：${counts.format} 个</li>`;
        }
        
        summaryHTML += '</ul>';
        summaryElement.innerHTML = summaryHTML;
        document.getElementById('generate-story-btn').classList.remove('hidden');
      }
    }
    
    // 根据选择的预设生成prompt
    function generatePromptFromPresets() {
      let prompt = "请根据以下设定创作一个引人入胜的故事：\n\n";
      
      // 添加角色设定
      if(selectedPresets.character.length > 0) {
        prompt += "【角色设定】\n";
        selectedPresets.character.forEach(id => {
          const character = presetData.character.find(c => c.id === id);
          if(character) {
            prompt += `- ${character.name}：${character.desc}\n`;
          }
        });
        prompt += "\n";
      }
      
      // 添加玩家人设
      if(selectedPresets.player && selectedPresets.player.length > 0) {
        prompt += "【玩家人设】\n";
        selectedPresets.player.forEach(id => {
          const player = presetData.player.find(p => p.id === id);
          if(player) {
            prompt += `- ${player.name}：${player.desc}\n`;
          }
        });
        prompt += "\n";
      }
      
      // 添加世界观设定
      if(selectedPresets.world.length > 0) {
        prompt += "【世界观设定】\n";
        selectedPresets.world.forEach(id => {
          const world = presetData.world.find(w => w.id === id);
          if(world) {
            prompt += `- ${world.name}：${world.desc}\n`;
          }
        });
        prompt += "\n";
      }
      
      // 添加剧本设定
      if(selectedPresets.script.length > 0) {
        prompt += "【剧情设定】\n";
        selectedPresets.script.forEach(id => {
          const script = presetData.script.find(s => s.id === id);
          if(script) {
            prompt += `- ${script.name}：${script.desc}\n`;
          }
        });
        prompt += "\n";
      }
      
      // 添加文风设定
      if(selectedPresets.style.length > 0) {
        prompt += "【文风要求】\n";
        selectedPresets.style.forEach(id => {
          const style = presetData.style.find(s => s.id === id);
          if(style) {
            prompt += `- ${style.name}：${style.desc}\n`;
          }
        });
        prompt += "\n";
      }
      
      // 添加内容格式
      if(selectedPresets.format && selectedPresets.format.length > 0) {
        prompt += "【内容格式】\n";
        selectedPresets.format.forEach(id => {
          const format = presetData.format.find(f => f.id === id);
          if(format) {
            prompt += `- ${format.name}：${format.desc}\n`;
          }
        });
        prompt += "\n";
      }
      
      prompt += "请创作第一章的内容，确保故事情节连贯，人物形象鲜明，符合上述设定要求。";
      
      return prompt;
    }
    // 弹窗编辑
    function showPresetEdit(tab, item) {
      const isEdit = !!item;
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black/40 z-50 flex items-center justify-center';
      modal.innerHTML = `<div class='bg-white dark:bg-slate-800 rounded-xl shadow-xl w-full max-w-md p-6'><h3 class='text-lg font-semibold mb-4'>${isEdit?'编辑':'新增'}${{character:'人设',player:'玩家人设',world:'世界观',style:'文风',script:'剧本',format:'内容格式'}[tab]}</h3><div class='space-y-3'><input id='preset-edit-name' class='w-full px-3 py-2 border rounded dark:bg-slate-700 dark:border-slate-600 dark:text-light' placeholder='名称' value='${item?item.name:''}'/><textarea id='preset-edit-desc' class='w-full px-3 py-2 border rounded dark:bg-slate-700 dark:border-slate-600 dark:text-light' placeholder='描述'>${item?item.desc||'':''}</textarea></div><div class='mt-4 flex justify-end space-x-2'><button id='preset-edit-cancel' class='px-4 py-1 rounded bg-gray-200 hover:bg-gray-300 dark:bg-slate-700 dark:hover:bg-slate-600 dark:text-light'>取消</button><button id='preset-edit-save' class='px-4 py-1 rounded bg-primary text-white hover:bg-primary/90'>保存</button></div></div>`;
      document.body.appendChild(modal);
      modal.querySelector('#preset-edit-cancel').onclick = ()=>modal.remove();
      modal.querySelector('#preset-edit-save').onclick = ()=>{
        const name = modal.querySelector('#preset-edit-name').value.trim();
        const desc = modal.querySelector('#preset-edit-desc').value.trim();
        if(!name){alert('名称不能为空');return;}
        if(isEdit){ item.name=name; item.desc=desc; } else { presetData[tab].push({id:uuid(),name,desc}); }
        savePresets(); renderPresetTab(tab); modal.remove();
      };
    }
    // tab切换
    document.querySelectorAll('.tab-btn-preset').forEach(btn=>{
      btn.onclick = function(){
        document.querySelectorAll('.tab-btn-preset').forEach(b=>b.classList.remove('bg-primary','text-white'));
        this.classList.add('bg-primary','text-white');
        renderPresetTab(this.dataset.tab);
      };
    });
    // 当前预设标签页
    let currentPresetTab = 'character';
    
    // 初始化预设模态框
    function initPresetModal() {
      // 初始化标签页
      document.querySelectorAll('.tab-btn-preset').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.tab-btn-preset').forEach(b => b.classList.remove('bg-primary', 'text-white'));
          btn.classList.add('bg-primary', 'text-white');
          currentPresetTab = btn.dataset.tab;
          renderPresetTab(currentPresetTab);
          updateSelectedPresetsSummary();
        });
      });
      
      // 清空选择按钮
      document.getElementById('clear-all-presets').addEventListener('click', () => {
        if(confirm('确定要清空所有选择吗？')) {
          clearAllPresets();
        }
      });
      
      // 底部生成故事按钮
      document.getElementById('generate-from-presets').addEventListener('click', generateStoryFromPresets);
      
      // 默认选中第一个标签
      document.querySelector('.tab-btn-preset').click();
      
      // 初始化总览区域
      updateSelectedPresetsSummary();
    }
    
    // 初始化
    loadPresets();
    setTimeout(()=>{
      initPresetModal();
    }, 100);

    // --- INITIALIZATION ---
    const initApp = () => {
        const isDarkStored = localStorage.getItem('theme') === 'dark';
        const isDarkSystem = !('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches;
        if (isDarkStored || isDarkSystem) {
            document.documentElement.classList.add('dark');
            elements.themeToggle.querySelector('i').classList.replace('fa-moon-o', 'fa-sun-o');
        }
        
        loadState();
        parseApiKeys(); // Initialize key list on load
        const currentKey = getCurrentApiKey();
        if (currentKey) {
            elements.apiKey.value = currentKey; // Set the first key in the input field
        }

        if (story.length > 0) {
            renderChapter(currentChapterIndex);
        } else {
            renderWelcomeMessage();
        }
    };
    
    initApp();
});
// --- END: FULLY FUNCTIONAL JAVASCRIPT CODE ---
  </script>
</body>
</html>
