<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>爱小说</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <script>
    // Tailwind CSS Configuration
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            primary: '#4F46E5',
            secondary: '#10B981',
            accent: '#F59E0B',
            dark: '#111827',
            light: '#F8FAFC',
            'slate-800': '#1E293B',
            'slate-700': '#334155',
            'slate-600': '#475569',
          },
          fontFamily: {
            sans: ['Inter', 'system-ui', 'sans-serif'],
            reading: ['var(--reading-font)', 'Inter', 'system-ui', 'sans-serif'],
          },
        },
      }
    }
  </script>
  <style type="text/tailwindcss">
    @layer base {
      /* Reading Area CSS Variables */
      :root {
        --reading-font: 'Inter';
        --reading-font-size: 1.125rem; /* 18px */
        --reading-line-height: 1.75;
        --reading-letter-spacing: 0.025em;
        --reading-bg-color: #ffffff;
        --reading-text-color: #334155; /* slate-700 */
        --dialogue-highlight-color: #334155;
        --dialogue-highlight-weight: normal;
      }
      /* Dark Mode Variables */
      :root.dark {
        --reading-bg-color: #1E293B; /* slate-800 */
        --reading-text-color: #cbd5e1; /* slate-300 */
        --dialogue-highlight-color: #cbd5e1; /* slate-300 */
      }
    }
    @layer utilities {
      /* Custom utility classes */
      .transition-custom {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }
      .scrollbar-hide::-webkit-scrollbar { display: none; }
      .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
      .tab-button.active { @apply bg-primary text-white; }
      .dialogue-highlight {
        color: var(--dialogue-highlight-color);
        font-weight: var(--dialogue-highlight-weight);
      }
    }
  </style>
</head>
<body class="bg-gray-100 font-sans text-gray-800 min-h-screen flex flex-col dark:bg-dark dark:text-light">
  
  <!-- 1. Top Navigation Bar -->
  <header class="bg-white shadow-sm sticky top-0 z-50 dark:bg-slate-800 dark:border-b dark:border-slate-700">
    <div class="container mx-auto px-4 py-3 flex justify-between items-center">
      <h1 class="text-2xl font-bold text-primary flex items-center"><i class="fa fa-book mr-2"></i>爱小说</h1>
      <div class="flex items-center space-x-2">
        <button id="custom-prompt-btn" class="p-1 rounded-md hover:bg-gray-100 dark:hover:bg-slate-700 transition-custom" title="自定义情节"><i class="fa fa-magic text-gray-600 dark:text-gray-300"></i></button>
        <button id="continue-story-btn" class="p-1 rounded-md hover:bg-gray-100 dark:hover:bg-slate-700 transition-custom" title="继续故事"><i class="fa fa-play text-gray-600 dark:text-gray-300"></i></button>
        <button id="regenerate-chapter-btn" class="p-1 rounded-md hover:bg-gray-100 dark:hover:bg-slate-700 transition-custom" title="重新生成"><i class="fa fa-refresh text-gray-600 dark:text-gray-300"></i></button>
        <span class="text-gray-300 dark:text-gray-400 mx-1">|</span>
        <button id="open-model-settings-btn" class="p-1 rounded-md hover:bg-gray-100 dark:hover:bg-slate-700 transition-custom" title="配置模型"><i class="fa fa-cogs text-gray-600 dark:text-gray-300"></i></button>
        <button id="open-story-preset-btn" class="p-1 rounded-md hover:bg-gray-100 dark:hover:bg-slate-700 transition-custom" title="设置故事"><i class="fa fa-file-text-o text-gray-600 dark:text-gray-300"></i></button>
        <button id="theme-toggle-btn" class="p-1 rounded-md hover:bg-gray-100 dark:hover:bg-slate-700 transition-custom"><i class="fa fa-moon-o text-gray-600 dark:text-gray-300"></i></button>
      </div>
    </div>
  </header>

  <!-- 2. Main Content Area -->
  <main class="flex-grow container mx-auto px-4 py-6 flex flex-col">
    <!-- Chapter Navigation -->
    <div class="bg-white rounded-xl shadow-sm p-4 mb-6 flex flex-wrap gap-2 justify-between items-center transition-custom hover:shadow-md dark:bg-slate-800">
      <div class="flex items-center space-x-2">
        <button id="prev-chapter-btn" class="px-2 py-2 bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 transition-custom flex items-center disabled:opacity-50 disabled:cursor-not-allowed dark:bg-slate-700 dark:text-gray-300 dark:hover:bg-slate-600 text-sm"><i class="fa fa-arrow-left mr-1"></i>上章</button>
        <span id="chapter-info" class="text-sm text-gray-500 px-2 dark:text-gray-400">无内容</span>
        <button id="next-chapter-btn" class="px-2 py-2 bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 transition-custom flex items-center disabled:opacity-50 disabled:cursor-not-allowed dark:bg-slate-700 dark:text-gray-300 dark:hover:bg-slate-600 text-sm">下章 <i class="fa fa-arrow-right ml-1"></i></button>
      </div>
    </div>

    <!-- Reading Area -->
    <div class="bg-white rounded-xl shadow-sm overflow-hidden flex-grow transition-custom hover:shadow-md flex flex-col" style="background-color: var(--reading-bg-color);">
      <div id="reading-area" class="p-8 md:p-10 lg:p-12 min-h-[500px] relative flex-grow overflow-y-auto scrollbar-hide" style="color: var(--reading-text-color); font-family: var(--reading-font); font-size: var(--reading-font-size); line-height: var(--reading-line-height); letter-spacing: var(--reading-letter-spacing);">
        
        <!-- Loading State Overlay (Matches original document) -->
        <div id="loading-state" class="absolute inset-0 flex items-center justify-center bg-white/80 dark:bg-slate-800/80 z-10 hidden">
          <div class="text-center">
            <div class="inline-block animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-primary mb-4"></div>
            <p class="text-gray-600 dark:text-gray-300">AI创作中...</p>
          </div>
        </div>

        <!-- Content will be injected here -->
        <div id="content-container" class="hidden">
          <h1 id="chapter-title-display" class="text-3xl md:text-4xl font-bold mb-6 text-center" style="color: var(--reading-text-color);"></h1>
          <div id="content-area" class="prose max-w-none"></div>
        </div>

        <!-- Welcome Message (Matches original document) -->
        <div id="welcome-message" class="text-center p-10 flex flex-col items-center justify-center h-full">
            <i class="fa fa-magic text-6xl text-gray-300 dark:text-gray-600 mb-4"></i>
            <h2 class="text-2xl font-bold text-gray-700 dark:text-gray-300 mb-2">欢迎使用 爱小说</h2>
            <p class="text-gray-500 dark:text-gray-400 max-w-md mx-auto">请先点击顶部的 <i class="fa fa-cogs"></i> 图标配置AI模型，然后通过 <i class="fa fa-file-text-o"></i> 设定故事，或直接 <i class="fa fa-play"></i> 开始创作。</p>
        </div>
      </div>

      <!-- Bottom Toolbar -->
      <div class="bg-gray-50/50 border-t border-gray-200/80 p-3 flex justify-between items-center backdrop-blur-sm dark:bg-slate-800/80 dark:border-t-slate-700">
        <div class="flex items-center space-x-3">
          <div class="text-sm text-gray-500 dark:text-gray-400"><i class="fa fa-file-word-o mr-1"></i>字数: <span id="word-count">0</span></div>
          <div id="pagination-controls" class="flex items-center space-x-1 hidden">
              <button id="prev-page-btn" class="p-1 rounded-md hover:bg-gray-200 dark:hover:bg-slate-700 disabled:opacity-50" title="上一页"><i class="fa fa-chevron-left text-gray-600 dark:text-gray-300 text-sm"></i></button>
              <span id="page-info" class="text-xs text-gray-500 dark:text-gray-400 px-1"></span>
              <button id="next-page-btn" class="p-1 rounded-md hover:bg-gray-200 dark:hover:bg-slate-700 disabled:opacity-50" title="下一页"><i class="fa fa-chevron-right text-gray-600 dark:text-gray-300 text-sm"></i></button>
          </div>
        </div>
        <div class="flex space-x-1">
          <button id="edit-chapter-btn" class="p-1.5 rounded-md hover:bg-gray-200 dark:hover:bg-slate-700" title="编辑章节"><i class="fa fa-edit text-gray-600 dark:text-gray-300 text-sm"></i></button>
          <button id="open-reading-settings-btn" class="p-1.5 rounded-md hover:bg-gray-200 dark:hover:bg-slate-700" title="阅读设置"><i class="fa fa-sliders text-gray-600 dark:text-gray-300 text-sm"></i></button>
          <button id="export-chapter-btn" class="p-1.5 rounded-md hover:bg-gray-200 dark:hover:bg-slate-700" title="导出本章"><i class="fa fa-download text-gray-600 dark:text-gray-300 text-sm"></i></button>
          <button id="export-all-btn" class="p-1.5 rounded-md hover:bg-gray-200 dark:hover:bg-slate-700" title="导出全部"><i class="fa fa-save text-gray-600 dark:text-gray-300 text-sm"></i></button>
        </div>
      </div>
    </div>
  </main>

  <!-- 3. Modals -->
  <!-- Reading Settings Modal -->
  <div id="reading-settings-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden p-4">
    <div class="bg-white rounded-xl shadow-xl w-full max-w-md max-h-[90vh] flex flex-col dark:bg-slate-800">
      <div class="p-5 border-b flex justify-between items-center dark:border-slate-700">
        <h3 class="text-lg font-semibold text-primary">阅读设置</h3>
        <button class="close-modal-btn p-2 rounded-full hover:bg-gray-100 dark:hover:bg-slate-700"><i class="fa fa-times text-gray-600 dark:text-gray-300"></i></button>
      </div>
      <div class="p-6 space-y-6 overflow-y-auto">
        <div>
          <h4 class="text-md font-medium text-gray-700 mb-3 dark:text-gray-300"><i class="fa fa-font mr-2 text-primary"></i>字体样式</h4>
          <div class="space-y-4">
            <div>
              <label for="font-size-slider" class="block text-sm font-medium text-gray-600 mb-1 dark:text-gray-400">字体大小: <span id="font-size-value">18px</span></label>
              <input type="range" id="font-size-slider" min="12" max="32" step="1" value="18" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-slate-600">
            </div>
            <div>
              <label for="line-height-slider" class="block text-sm font-medium text-gray-600 mb-1 dark:text-gray-400">行间距: <span id="line-height-value">1.75</span></label>
              <input type="range" id="line-height-slider" min="1.2" max="2.5" step="0.05" value="1.75" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-slate-600">
            </div>
          </div>
        </div>
        <div>
          <h4 class="text-md font-medium text-gray-700 mb-3 dark:text-gray-300"><i class="fa fa-upload mr-2 text-primary"></i>自定义字体</h4>
          <input type="file" id="font-upload-input" accept=".ttf,.otf,.woff,.woff2" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-primary/10 file:text-primary hover:file:bg-primary/20 cursor-pointer dark:text-gray-400 dark:file:bg-primary/20 dark:hover:file:bg-primary/30">
        </div>
        <div>
          <h4 class="text-md font-medium text-gray-700 mb-3 dark:text-gray-300"><i class="fa fa-comments-o mr-2 text-primary"></i>对话高亮</h4>
          <div class="space-y-3">
            <label class="flex items-center space-x-3 cursor-pointer">
              <input type="checkbox" id="dialogue-bold-toggle" class="h-4 w-4 rounded border-gray-300 text-primary focus:ring-primary dark:bg-slate-700 dark:border-slate-600">
              <span class="text-sm font-medium text-gray-700 dark:text-gray-300">对话内容加粗</span>
            </label>
            <div class="flex items-center space-x-3">
              <label for="dialogue-color-picker" class="text-sm font-medium text-gray-700 dark:text-gray-300">对话文字颜色:</label>
              <input type="color" id="dialogue-color-picker" value="#334155" class="w-10 h-8 p-1 border rounded-md cursor-pointer dark:bg-slate-700 dark:border-slate-600">
              <button id="reset-dialogue-color-btn" class="text-xs text-gray-500 hover:text-primary dark:text-gray-400">重置</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Custom Prompt Modal -->
  <div id="custom-prompt-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden p-4">
      <div class="bg-white rounded-xl shadow-xl w-full max-w-lg dark:bg-slate-800">
          <div class="p-5 border-b flex justify-between items-center dark:border-slate-700">
              <h3 class="text-lg font-semibold text-primary">自定义生成</h3>
              <button class="close-modal-btn p-2 rounded-full hover:bg-gray-100 dark:hover:bg-slate-700"><i class="fa fa-times text-gray-600 dark:text-gray-300"></i></button>
          </div>
          <div class="p-6">
              <textarea id="custom-prompt-input" class="w-full p-3 border rounded-md focus:outline-none focus:ring-2 focus:ring-primary/50 h-40 dark:bg-slate-700 dark:border-slate-600 dark:text-light" placeholder="请输入你希望接下来发生的情节..."></textarea>
              <div class="mt-4 flex justify-end">
                  <button id="submit-custom-prompt-btn" class="px-6 py-2 bg-secondary text-white rounded-md hover:bg-secondary/90 transition-custom">生成</button>
              </div>
          </div>
      </div>
  </div>

  <!-- Edit Chapter Modal -->
  <div id="edit-chapter-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden p-4">
      <div class="bg-white rounded-xl shadow-xl w-full max-w-4xl max-h-[90vh] flex flex-col dark:bg-slate-800">
          <div class="p-5 border-b flex justify-between items-center dark:border-slate-700">
              <h3 class="text-lg font-semibold text-primary">编辑章节</h3>
              <button class="close-modal-btn p-2 rounded-full hover:bg-gray-100 dark:hover:bg-slate-700"><i class="fa fa-times text-gray-600 dark:text-gray-300"></i></button>
          </div>
          <div class="p-6 flex-grow flex flex-col">
              <input type="text" id="edit-chapter-title-input" class="w-full p-3 mb-4 border rounded-md dark:bg-slate-700 dark:border-slate-600" placeholder="章节标题">
              <textarea id="edit-chapter-content-input" class="flex-grow w-full p-3 border rounded-md resize-none dark:bg-slate-700 dark:border-slate-600" style="min-height: 300px;"></textarea>
              <div class="mt-4 flex justify-between items-center">
                  <button id="delete-chapter-btn" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 flex items-center"><i class="fa fa-trash mr-2"></i>删除章节</button>
                  <div>
                      <button id="save-edit-btn" class="px-6 py-2 bg-primary text-white rounded-md hover:bg-primary/90">保存</button>
                  </div>
              </div>
          </div>
      </div>
  </div>

  <!-- Model Settings Modal -->
  <div id="model-settings-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden p-4">
      <div class="bg-white rounded-xl shadow-xl w-full max-w-2xl max-h-[90vh] flex flex-col dark:bg-slate-800">
          <div class="p-5 border-b flex justify-between items-center dark:border-slate-700">
              <h3 class="text-lg font-semibold text-primary">模型设置</h3>
              <button class="close-modal-btn p-2 rounded-full hover:bg-gray-100 dark:hover:bg-slate-700"><i class="fa fa-times text-gray-600 dark:text-gray-300"></i></button>
          </div>
          <div class="p-6 space-y-6 overflow-y-auto">
              <div>
                  <h2 class="text-lg font-semibold mb-4 flex items-center text-primary"><i class="fa fa-plug mr-2"></i>API 配置</h2>
                  <div class="space-y-3">
                      <div>
                          <label for="api-type-select" class="block text-sm font-medium mb-1 dark:text-gray-300">API 类型</label>
                          <select id="api-type-select" class="w-full p-2 border rounded-md dark:bg-slate-700 dark:border-slate-600"><option value="openai">OpenAI</option><option value="gemini">Gemini</option></select>
                      </div>
                      <div>
                          <label for="api-url-input" class="block text-sm font-medium mb-1 dark:text-gray-300">API 地址</label>
                          <input type="url" id="api-url-input" class="w-full p-2 border rounded-md dark:bg-slate-700 dark:border-slate-600 transition-colors" placeholder="https://api.openai.com/v1/chat/completions">
                      </div>
                      <div>
                        <label class="block text-sm font-medium mb-1 dark:text-gray-300">API Key 配置</label>
                        <div id="api-key-display" class="hidden p-3 border rounded-md bg-gray-50 dark:bg-slate-700 dark:border-slate-600">
                          <div class="flex justify-between items-center">
                              <ul id="masked-keys-list" class="space-y-1 text-sm font-mono text-gray-600 dark:text-gray-300"></ul>
                              <button id="edit-api-keys-btn" class="text-sm text-primary hover:underline">编辑</button>
                          </div>
                        </div>
                        <textarea id="api-key-input" rows="3" class="w-full p-2 border rounded-md dark:bg-slate-700 dark:border-slate-600 font-mono text-sm" placeholder="可输入多个Key，用逗号或换行分隔，每次生成时会自动轮换。"></textarea>
                        <p class="mt-1 text-xs text-yellow-600 dark:text-yellow-400"><i class="fa fa-warning mr-1"></i>注意：API密钥将经过混淆后保存在您的浏览器本地，请勿在不信任的计算机上使用。</p>
                      </div>
                      <button type="button" id="connect-api-btn" class="w-full bg-primary text-white py-2 rounded-md hover:bg-primary/90 flex items-center justify-center"><i class="fa fa-link mr-2"></i>连接模型</button>
                      <div id="api-status" class="hidden text-sm py-2 px-3 rounded-md text-center"></div>
                  </div>
              </div>
              <div>
                  <h2 class="text-lg font-semibold mb-4 flex items-center text-primary"><i class="fa fa-sliders mr-2"></i>生成参数</h2>
                  <div class="space-y-3">
                    <div>
                      <label for="model-select" class="block text-sm font-medium mb-1 dark:text-gray-300">选择模型</label>
                      <select id="model-select" class="w-full p-2 border rounded-md dark:bg-slate-700 dark:border-slate-600" disabled><option value="">请先连接API</option></select>
                    </div>
                    <div>
                      <label for="context-memory-slider" class="block text-sm font-medium mb-1 dark:text-gray-300">上下文记忆: <span id="context-memory-value">3</span> 章</label>
                      <input type="range" id="context-memory-slider" min="0" max="20" value="3" class="w-full h-2 bg-gray-200 rounded-lg cursor-pointer dark:bg-slate-600">
                    </div>
                    <div>
                      <label for="temperature-slider" class="block text-sm font-medium mb-1 dark:text-gray-300">创意温度: <span id="temperature-value">0.7</span></label>
                      <input type="range" id="temperature-slider" min="0.1" max="1.5" step="0.1" value="0.7" class="w-full h-2 bg-gray-200 rounded-lg cursor-pointer dark:bg-slate-600">
                    </div>
                  </div>
              </div>
          </div>
      </div>
  </div>

  <!-- Story Preset Modal -->
  <div id="story-preset-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden p-4">
    <div class="bg-white rounded-xl shadow-xl w-full max-w-2xl max-h-[90vh] flex flex-col dark:bg-slate-800">
      <div class="p-5 border-b flex justify-between items-center dark:border-slate-700">
        <h3 class="text-lg font-semibold text-primary">故事预设</h3>
        <button class="close-modal-btn p-2 rounded-full hover:bg-gray-100 dark:hover:bg-slate-700"><i class="fa fa-times text-gray-600 dark:text-gray-300"></i></button>
      </div>
      <div class="p-6 flex-grow flex flex-col overflow-hidden">
        <div class="flex-shrink-0 mb-4 flex justify-between items-center">
            <div id="preset-tabs-container" class="flex space-x-1 border border-gray-200 dark:border-slate-600 rounded-lg p-1"></div>
            <button id="add-preset-btn" class="px-3 py-1 bg-primary text-white text-sm rounded-md hover:bg-primary/90 flex items-center"><i class="fa fa-plus mr-1"></i>新增</button>
        </div>
        <div id="preset-list-container" class="flex-grow overflow-y-auto space-y-2 pr-2"></div>
        <div class="flex-shrink-0 mt-6 pt-4 border-t dark:border-slate-700 flex justify-center">
            <button id="generate-from-presets-btn" class="px-6 py-2 bg-secondary text-white rounded-md hover:bg-secondary/90 flex items-center"><i class="fa fa-magic mr-2"></i>根据选择生成故事</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Preset Editor Modal (A modal inside a modal pattern, handled by JS) -->
  <!-- This modal is created and destroyed dynamically by JS -->

  <!-- 4. JavaScript -->
  <script src="https://cdn.jsdelivr.net/npm/showdown@2.1.0/dist/showdown.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {

        // --- I. STATE & CONFIGURATION ---

        const LS_KEYS = {
            STATE: 'aiNovelState_v3',
            PRESETS: 'aiNovelPresets_v3',
            THEME: 'aiNovelTheme_v3'
        };

        let story = [];
        let currentChapterIndex = -1;
        let chapterPages = [];
        let currentPageIndex = 0;
        let apiConfig = { type: 'openai', url: '', keys: [], currentKeyIndex: 0, isConnected: false, models: [] };
        
        let presetData = {};
        let selectedPresets = {};
        let activePresetTab = 'character';
        const PRESET_CATEGORIES = {
            character: '角色', player: '玩家', world: '世界观', 
            style: '文风', script: '剧本', format: '格式'
        };

        const mdConverter = new showdown.Converter({ noHeaderId: true, simplifiedAutoLink: true, openLinksInNewWindow: true });

        // --- II. DOM ELEMENT CACHE ---
        
        const $ = (selector) => document.querySelector(selector);
        const $$ = (selector) => document.querySelectorAll(selector);

        const elements = {
            themeToggleBtn: $('#theme-toggle-btn'), loadingState: $('#loading-state'),
            contentContainer: $('#content-container'), welcomeMessage: $('#welcome-message'),
            chapterTitleDisplay: $('#chapter-title-display'), contentArea: $('#content-area'),
            readingArea: $('#reading-area'), prevChapterBtn: $('#prev-chapter-btn'),
            nextChapterBtn: $('#next-chapter-btn'), chapterInfo: $('#chapter-info'),
            paginationControls: $('#pagination-controls'), prevPageBtn: $('#prev-page-btn'),
            nextPageBtn: $('#next-page-btn'), pageInfo: $('#page-info'),
            wordCount: $('#word-count'), editChapterBtn: $('#edit-chapter-btn'),
            exportChapterBtn: $('#export-chapter-btn'), exportAllBtn: $('#export-all-btn'),
            modals: { readingSettings: $('#reading-settings-modal'), customPrompt: $('#custom-prompt-modal'), editChapter: $('#edit-chapter-modal'), modelSettings: $('#model-settings-modal'), storyPreset: $('#story-preset-modal') },
            openers: { readingSettings: $('#open-reading-settings-btn'), customPrompt: $('#custom-prompt-btn'), editChapter: $('#edit-chapter-btn'), modelSettings: $('#open-model-settings-btn'), storyPreset: $('#open-story-preset-btn') },
            continueStoryBtn: $('#continue-story-btn'), regenerateChapterBtn: $('#regenerate-chapter-btn'),
            fontSizeSlider: $('#font-size-slider'), fontSizeValue: $('#font-size-value'),
            lineHeightSlider: $('#line-height-slider'), lineHeightValue: $('#line-height-value'),
            fontUploadInput: $('#font-upload-input'), dialogueBoldToggle: $('#dialogue-bold-toggle'),
            dialogueColorPicker: $('#dialogue-color-picker'), resetDialogueColorBtn: $('#reset-dialogue-color-btn'),
            customPromptInput: $('#custom-prompt-input'), submitCustomPromptBtn: $('#submit-custom-prompt-btn'),
            editChapterTitleInput: $('#edit-chapter-title-input'), editChapterContentInput: $('#edit-chapter-content-input'),
            saveEditBtn: $('#save-edit-btn'), deleteChapterBtn: $('#delete-chapter-btn'),
            apiTypeSelect: $('#api-type-select'), apiUrlInput: $('#api-url-input'),
            apiKeyInput: $('#api-key-input'), apiKeyDisplay: $('#api-key-display'),
            maskedKeysList: $('#masked-keys-list'), editApiKeysBtn: $('#edit-api-keys-btn'),
            connectApiBtn: $('#connect-api-btn'), apiStatus: $('#api-status'),
            modelSelect: $('#model-select'), contextMemorySlider: $('#context-memory-slider'),
            contextMemoryValue: $('#context-memory-value'), temperatureSlider: $('#temperature-slider'),
            temperatureValue: $('#temperature-value'), presetTabsContainer: $('#preset-tabs-container'),
            addPresetBtn: $('#add-preset-btn'), presetListContainer: $('#preset-list-container'),
            generateFromPresetsBtn: $('#generate-from-presets-btn'),
        };
        
        // --- III. CORE LOGIC & HELPER FUNCTIONS ---

        const saveState = () => {
            const stateToSave = {
                story, currentChapterIndex,
                apiConfig: { ...apiConfig, keys: apiConfig.keys.map(key => btoa(key)) },
                modelSettings: { model: elements.modelSelect.value, contextMemory: elements.contextMemorySlider.value, temperature: elements.temperatureSlider.value },
                readingSettings: { fontSize: elements.fontSizeSlider.value, lineHeight: elements.lineHeightSlider.value, dialogueBold: elements.dialogueBoldToggle.checked, dialogueColor: elements.dialogueColorPicker.value }
            };
            localStorage.setItem(LS_KEYS.STATE, JSON.stringify(stateToSave));
        };
        
        const loadState = () => {
            const savedState = localStorage.getItem(LS_KEYS.STATE);
            if (!savedState) return;
            try {
                const state = JSON.parse(savedState);
                story = state.story || [];
                currentChapterIndex = state.currentChapterIndex ?? -1;
                
                if (state.apiConfig) {
                    apiConfig = { ...state.apiConfig, keys: (state.apiConfig.keys || []).map(key => { try { return atob(key) } catch { return '' } }).filter(Boolean) };
                    elements.apiTypeSelect.value = apiConfig.type || 'openai';
                    elements.apiUrlInput.value = apiConfig.url || '';
                }

                if (state.modelSettings) {
                    localStorage.setItem('aiNovelLastModel', state.modelSettings.model || '');
                    elements.contextMemorySlider.value = state.modelSettings.contextMemory || 3;
                    elements.temperatureSlider.value = state.modelSettings.temperature || 0.7;
                }
                if (state.readingSettings) {
                    elements.fontSizeSlider.value = state.readingSettings.fontSize || 18;
                    elements.lineHeightSlider.value = state.readingSettings.lineHeight || 1.75;
                    elements.dialogueBoldToggle.checked = state.readingSettings.dialogueBold || false;
                    elements.dialogueColorPicker.value = state.readingSettings.dialogueColor || '#334155';
                }
            } catch (e) {
                console.error("Failed to load state:", e);
                localStorage.removeItem(LS_KEYS.STATE);
            }
        };

        const savePresets = () => localStorage.setItem(LS_KEYS.PRESETS, JSON.stringify({ data: presetData, selected: selectedPresets }));
        const loadPresets = () => {
            const raw = localStorage.getItem(LS_KEYS.PRESETS);
            Object.keys(PRESET_CATEGORIES).forEach(key => { presetData[key] = []; selectedPresets[key] = []; });
            if (raw) { try { const p = JSON.parse(raw); if (p.data) presetData = p.data; if (p.selected) selectedPresets = p.selected; } catch (e) { console.error("Failed to load presets:", e); } }
        };
        
        const getNextApiKey = () => {
            if (!apiConfig.isConnected || !apiConfig.keys.length) return null;
            const key = apiConfig.keys[apiConfig.currentKeyIndex];
            apiConfig.currentKeyIndex = (apiConfig.currentKeyIndex + 1) % apiConfig.keys.length;
            saveState();
            return key;
        };

        const fetchFromApi = async (endpoint, options) => {
            const response = await fetch(endpoint, options);
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData?.error?.message || `HTTP Error: ${response.status}`);
            }
            return response.json();
        };

        const connectToApi = async () => {
            const type = elements.apiTypeSelect.value;
            const url = elements.apiUrlInput.value.trim();
            const keysInput = elements.apiKeyInput.value.trim();

            if (!url || !keysInput) return updateApiStatus('URL和API Key不能为空。', 'error');

            const keys = keysInput.split(/[\s,]+/).filter(Boolean);
            if (!keys.length) return updateApiStatus('请输入一个有效的API Key。', 'error');
            
            updateApiStatus('正在连接...', 'loading');
            
            try {
                const testKey = keys[0];
                let modelsUrl, headers;
                if (type === 'openai') {
                    modelsUrl = `${url.replace(/\/v1\/.*$/, '')}/v1/models`;
                    headers = { 'Authorization': `Bearer ${testKey}` };
                } else {
                    modelsUrl = `https://generativelanguage.googleapis.com/v1beta/models?key=${testKey}`;
                    headers = {};
                }

                const data = await fetchFromApi(modelsUrl, { headers });
                const apiModels = (type === 'openai' ? data.data : data.models) || [];
                
                const modelList = [];
                elements.modelSelect.innerHTML = '';
                apiModels.forEach(model => {
                    const modelId = model.id || model.name;
                    if (!modelId || (type === 'openai' && (modelId.includes('embed') || modelId.includes('vision')))) return;
                    const finalId = modelId.startsWith('models/') ? modelId.substring(7) : modelId;
                    modelList.push(finalId);
                    elements.modelSelect.add(new Option(finalId, finalId));
                });

                if (elements.modelSelect.options.length > 0) {
                    elements.modelSelect.value = localStorage.getItem('aiNovelLastModel') || '';
                    elements.modelSelect.disabled = false;
                    apiConfig = { type, url, keys, currentKeyIndex: 0, isConnected: true, models: modelList };
                    const successMessage = `连接成功！发现 ${modelList.length} 个模型。${keys.length > 1 ? `已配置 ${keys.length} 个Key进行轮换。` : ''}`;
                    updateApiStatus(successMessage, 'success');
                    renderApiKeyDisplay();
                    saveState();
                } else {
                    throw new Error("未找到兼容的模型。");
                }
            } catch (error) {
                apiConfig.isConnected = false;
                apiConfig.models = [];
                saveState();
                elements.modelSelect.disabled = true;
                elements.modelSelect.innerHTML = '<option value="">连接失败</option>';
                updateApiStatus(`连接失败: ${error.message}`, 'error');
            }
        };

        const generateChapter = async (userPrompt, isRegeneration = false) => {
            if (!apiConfig.isConnected) return alert('请先在模型设置中连接API。');
            const apiKey = getNextApiKey();
            if (!apiKey) {
                toggleLoading(false);
                return alert('API已连接，但未配置密钥。请重新配置。');
            }
            toggleLoading(true);

            const contextMemory = parseInt(elements.contextMemorySlider.value, 10);
            const temperature = parseFloat(elements.temperatureSlider.value);
            const model = elements.modelSelect.value;
            const promptData = buildFullPrompt(userPrompt, contextMemory, isRegeneration);

            let endpoint = apiConfig.url, payload, headers;
            if (apiConfig.type === 'openai') {
                payload = { model, temperature, messages: promptData.messages };
                headers = { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` };
            } else {
                payload = { generationConfig: { temperature }, contents: [{ role: 'user', parts: [{ text: promptData.fullPrompt }] }] };
                endpoint = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;
                headers = { 'Content-Type': 'application/json' };
            }

            try {
                const data = await fetchFromApi(endpoint, { method: 'POST', headers, body: JSON.stringify(payload) });
                const newContent = (apiConfig.type === 'openai' ? data.choices?.[0]?.message?.content : data.candidates?.[0]?.content?.parts?.[0]?.text)?.trim();
                if (!newContent) throw new Error('API返回内容为空。');

                if (isRegeneration) {
                    story[currentChapterIndex].content = newContent;
                    story[currentChapterIndex].customPrompt = userPrompt;
                } else {
                    const newIndex = story.length;
                    story.push({ title: `第 ${newIndex + 1} 章`, content: newContent, customPrompt: userPrompt });
                    currentChapterIndex = newIndex;
                }
                renderChapter(currentChapterIndex);
            } catch (error) {
                console.error('生成失败:', error);
                alert(`生成失败: ${error.message}`);
                toggleLoading(false);
            }
        };

        const buildFullPrompt = (userPrompt, contextMemory, isRegeneration) => { 
            const presetsPrompt = generatePromptFromSelectedPresets();
            const formatPreset = presetData.format?.find(p => selectedPresets.format?.includes(p.id));
            const formatInstructions = formatPreset ? formatPreset.desc : "Use Markdown format. Chapter title as H1.";
            const systemContent = `You are a talented novelist. Create the story based on the following settings and requirements.\n\n### Story Presets\n${presetsPrompt}\n\n### Output Format\n${formatInstructions}`;
            const contextStory = isRegeneration ? story.slice(0, currentChapterIndex) : story;
            const contextChapters = contextMemory > 0 ? contextStory.slice(-contextMemory) : [];
            let fullPrompt = `${systemContent}\n\n`;
            if(contextChapters.length > 0) fullPrompt += "### Previous Chapters (for context)\n" + contextChapters.map(c => `# ${c.title}\n${c.content}`).join('\n\n') + '\n\n';
            fullPrompt += `### Current Task\n${userPrompt}`;
            let messages = [{ role: 'system', content: systemContent }];
            if(contextChapters.length > 0) {
                messages.push({ role: 'user', content: "Here is the context from previous chapters:\n\n" + contextChapters.map(c => `# ${c.title}\n${c.content}`).join('\n\n') });
                messages.push({ role: 'assistant', content: 'Understood. I have the context. What should I write next?' });
            }
            messages.push({ role: 'user', content: `### Current Task\n${userPrompt}` });
            return { fullPrompt, messages };
        };
        
        // --- IV. UI RENDERING & UPDATES ---
        
        const handleApiTypeChange = () => {
            const type = elements.apiTypeSelect.value;
            const urlInput = elements.apiUrlInput;
            if (type === 'gemini') {
                urlInput.value = 'https://generativelanguage.googleapis.com';
                urlInput.readOnly = true;
                urlInput.classList.add('bg-gray-100', 'dark:bg-slate-700/50', 'cursor-not-allowed');
            } else {
                urlInput.readOnly = false;
                urlInput.classList.remove('bg-gray-100', 'dark:bg-slate-700/50', 'cursor-not-allowed');
                urlInput.placeholder = 'https://api.openai.com/v1/chat/completions';
                urlInput.value = (apiConfig.type === 'openai' && apiConfig.url) ? apiConfig.url : '';
            }
        };
        
        const renderChapter = (index) => {
            toggleLoading(false);
            if (index < 0 || index >= story.length) {
              showWelcomeScreen();
              return;
            }
            hideWelcomeScreen();
            currentChapterIndex = index;
            const chapter = story[index];
            let contentHtml = mdConverter.makeHtml(chapter.content);
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = contentHtml;
            const h1 = tempDiv.querySelector('h1');
            if (h1) { chapter.title = h1.textContent.trim(); h1.remove(); contentHtml = tempDiv.innerHTML; }
            contentHtml = highlightDialogue(contentHtml);
            elements.chapterTitleDisplay.textContent = chapter.title;
            chapterPages = paginateContent(contentHtml, 2500);
            currentPageIndex = 0;
            renderCurrentPage();
            elements.readingArea.scrollTop = 0;
            updateUI();
            saveState();
        };

        const renderCurrentPage = () => { elements.contentArea.innerHTML = chapterPages[currentPageIndex] || ''; updatePaginationUI(); };
        
        const updateUI = () => {
            const hasStory = story.length > 0;
            elements.chapterInfo.textContent = hasStory ? `第 ${currentChapterIndex + 1} / ${story.length} 章` : '无内容';
            elements.prevChapterBtn.disabled = !hasStory || currentChapterIndex === 0;
            elements.nextChapterBtn.disabled = !hasStory || currentChapterIndex === story.length - 1;
            [elements.continueStoryBtn, elements.regenerateChapterBtn, elements.editChapterBtn, elements.exportChapterBtn, elements.exportAllBtn, elements.openers.customPrompt].forEach(btn => { btn.disabled = !hasStory; });
            elements.wordCount.textContent = hasStory ? (story[currentChapterIndex].content.match(/[\u4e00-\u9fa5\w]+/g) || []).join('').length : 0;
            elements.contextMemoryValue.textContent = elements.contextMemorySlider.value;
            elements.temperatureValue.textContent = elements.temperatureSlider.value;
            elements.fontSizeValue.textContent = `${elements.fontSizeSlider.value}px`;
            elements.lineHeightValue.textContent = elements.lineHeightSlider.value;
        };
        
        const updatePaginationUI = () => {
             if (chapterPages.length > 1) {
                elements.paginationControls.classList.remove('hidden');
                elements.pageInfo.textContent = `${currentPageIndex + 1} / ${chapterPages.length}`;
                elements.prevPageBtn.disabled = currentPageIndex === 0;
                elements.nextPageBtn.disabled = currentPageIndex >= chapterPages.length - 1;
            } else {
                elements.paginationControls.classList.add('hidden');
            }
        };

        const updateApiStatus = (message, type) => {
            const s = elements.apiStatus;
            s.textContent = message;
            s.className = 'text-sm py-2 px-3 rounded-md text-center';
            if (type === 'success') s.classList.add('bg-green-100', 'text-green-800', 'dark:bg-green-900/50', 'dark:text-green-300');
            else if (type === 'error') s.classList.add('bg-red-100', 'text-red-800', 'dark:bg-red-900/50', 'dark:text-red-300');
            else s.classList.add('bg-yellow-100', 'text-yellow-800', 'dark:bg-yellow-900/50', 'dark:text-yellow-300');
            elements.connectApiBtn.innerHTML = type === 'loading' ? '<i class="fa fa-spinner fa-spin mr-2"></i>正在连接...' : '<i class="fa fa-link mr-2"></i>连接模型';
            elements.connectApiBtn.disabled = (type === 'loading');
        };

        const showWelcomeScreen = () => { elements.contentContainer.classList.add('hidden'); elements.welcomeMessage.classList.remove('hidden'); currentChapterIndex = -1; updateUI(); };
        const hideWelcomeScreen = () => { elements.contentContainer.classList.remove('hidden'); elements.welcomeMessage.classList.add('hidden'); };
        const toggleLoading = (isLoading) => elements.loadingState.classList.toggle('hidden', !isLoading);

        // --- V. UI HELPERS & MODAL LOGIC ---
        
        const maskApiKey = (key) => `${key.substring(0, 5)}...${key.substring(key.length - 4)}`;
        const renderApiKeyDisplay = () => {
            const hasKeys = apiConfig.keys && apiConfig.keys.length > 0;
            elements.apiKeyInput.classList.toggle('hidden', hasKeys);
            elements.apiKeyDisplay.classList.toggle('hidden', !hasKeys);

            if (hasKeys) {
                elements.maskedKeysList.innerHTML = apiConfig.keys.map((key, index) => 
                    `<li>Key ${index + 1}: ${maskApiKey(key)}</li>`
                ).join('');
            }
        };
        
        const restoreApiConnectionUI = () => {
            if (apiConfig.isConnected && apiConfig.models && apiConfig.models.length > 0) {
                elements.modelSelect.innerHTML = '';
                apiConfig.models.forEach(modelId => { elements.modelSelect.add(new Option(modelId, modelId)); });
                const lastModel = localStorage.getItem('aiNovelLastModel');
                if (lastModel && apiConfig.models.includes(lastModel)) elements.modelSelect.value = lastModel;
                elements.modelSelect.disabled = false;
                const successMessage = `已连接! 找到 ${apiConfig.models.length} 个模型。${apiConfig.keys.length > 1 ? `正在轮换 ${apiConfig.keys.length} 个Key。` : ''}`;
                updateApiStatus(successMessage, 'success');
            }
        };

        const toggleModal = (modalName, show) => { elements.modals[modalName].classList.toggle('hidden', !show); };
        
        const applyReadingSettings = () => {
            const root = document.documentElement;
            root.style.setProperty('--reading-font-size', `${elements.fontSizeSlider.value}px`);
            root.style.setProperty('--reading-line-height', elements.lineHeightSlider.value);
            root.style.setProperty('--dialogue-highlight-weight', elements.dialogueBoldToggle.checked ? 'bold' : 'normal');
            root.style.setProperty('--dialogue-highlight-color', elements.dialogueColorPicker.value);
            updateUI();
            saveState();
        };

        const highlightDialogue = (text) => text.replace(/(“[^”]+”|‘[^’]+’|"[^"]+"|\'[^\']+\'|「[^」]+」|『[^』]+』)/g, `<span class="dialogue-highlight">$1</span>`);
        const paginateContent = (htmlContent, limit) => {
            const pages = [];
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = htmlContent;
            const nodes = Array.from(tempDiv.childNodes);
            if (nodes.length === 0) return [htmlContent];
            let currentPageHtml = '';
            for (const node of nodes) {
                if (currentPageHtml && (currentPageHtml.length + (node.textContent || '').length) > limit) {
                    pages.push(currentPageHtml);
                    currentPageHtml = '';
                }
                currentPageHtml += node.outerHTML || node.textContent;
            }
            if (currentPageHtml) pages.push(currentPageHtml);
            return pages;
        };
        const downloadAsTxt = (filename, text) => {
            const blob = new Blob(['\uFEFF' + text], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        };
        
        // --- VI. STORY PRESET LOGIC ---
        const renderPresetTabs = () => { elements.presetTabsContainer.innerHTML = Object.entries(PRESET_CATEGORIES).map(([key, name]) => `<button data-tab="${key}" class="tab-button px-3 py-1 text-sm rounded-md transition-colors ${activePresetTab === key ? 'active' : ''}">${name}</button>`).join(''); };
        const renderPresetList = () => { const list = presetData[activePresetTab] || []; elements.presetListContainer.innerHTML = list.length === 0 ? `<p class="text-center text-gray-500 py-4">此分类下无预设。</p>` : list.map(item => `<div class="p-3 rounded-lg flex items-center justify-between cursor-pointer transition-colors ${selectedPresets[activePresetTab]?.includes(item.id) ? 'bg-primary/10' : 'bg-gray-50 dark:bg-slate-700 hover:bg-gray-100 dark:hover:bg-slate-600'}"><div class="flex items-center flex-grow" data-action="toggle-select" data-id="${item.id}"><input type="checkbox" class="h-4 w-4 rounded border-gray-300 text-primary pointer-events-none" ${selectedPresets[activePresetTab]?.includes(item.id) ? 'checked' : ''}><div class="ml-3"><p class="font-semibold">${item.name}</p><p class="text-xs text-gray-500 dark:text-gray-400">${item.desc}</p></div></div><div class="flex space-x-1 ml-2"><button data-action="edit-preset" data-id="${item.id}" class="p-2 rounded-md hover:bg-gray-200 dark:hover:bg-slate-600"><i class="fa fa-edit text-sm"></i></button><button data-action="delete-preset" data-id="${item.id}" class="p-2 rounded-md hover:bg-red-100 dark:hover:bg-red-800/50"><i class="fa fa-trash text-sm text-red-500"></i></button></div></div>`).join(''); };
        const showPresetEditor = (itemToEdit = null) => { const isEditing = !!itemToEdit; const modalId = 'dynamic-preset-editor'; $(`#${modalId}`)?.remove(); const modal = document.createElement('div'); modal.id = modalId; modal.className = 'fixed inset-0 bg-black bg-opacity-60 z-[60] flex items-center justify-center p-4'; modal.innerHTML = `<div class="bg-white dark:bg-slate-800 rounded-xl shadow-xl w-full max-w-md p-6"><h3 class='text-lg font-semibold mb-4'>${isEditing ? '编辑' : '新增'} ${PRESET_CATEGORIES[activePresetTab]} 预设</h3><div class='space-y-3'><input id='preset-edit-name' class='w-full p-2 border rounded dark:bg-slate-700 dark:border-slate-600' placeholder='名称' value='${itemToEdit?.name || ''}'/><textarea id='preset-edit-desc' class='w-full p-2 border rounded dark:bg-slate-700 dark:border-slate-600 h-24' placeholder='描述'>${itemToEdit?.desc || ''}</textarea></div><div class='mt-4 flex justify-end space-x-2'><button id='preset-edit-cancel' class='px-4 py-2 rounded bg-gray-200 hover:bg-gray-300 dark:bg-slate-600'>取消</button><button id='preset-edit-save' class='px-4 py-2 rounded bg-primary text-white'>保存</button></div></div>`; document.body.appendChild(modal); modal.querySelector('#preset-edit-cancel').onclick = () => modal.remove(); modal.querySelector('#preset-edit-save').onclick = () => { const name = modal.querySelector('#preset-edit-name').value.trim(); const desc = modal.querySelector('#preset-edit-desc').value.trim(); if (!name) return alert('名称不能为空。'); if (isEditing) { itemToEdit.name = name; itemToEdit.desc = desc; } else { presetData[activePresetTab].push({ id: `p_${Date.now()}`, name, desc }); } savePresets(); renderPresetList(); modal.remove(); }; };
        const generatePromptFromSelectedPresets = () => { let prompt = ""; Object.entries(selectedPresets).forEach(([category, ids]) => { if (ids.length === 0) return; prompt += `### ${PRESET_CATEGORIES[category]}\n`; ids.forEach(id => { const item = presetData[category].find(p => p.id === id); if (item) prompt += `- ${item.name}: ${item.desc}\n`; }); prompt += '\n'; }); return prompt || "无预设，请自由发挥。"; };

        // --- VII. EVENT LISTENERS ---

        function initializeEventListeners() {
            elements.themeToggleBtn.addEventListener('click', () => { const isDark = document.documentElement.classList.toggle('dark'); localStorage.setItem(LS_KEYS.THEME, isDark ? 'dark' : 'light'); elements.themeToggleBtn.querySelector('i').className = `fa ${isDark ? 'fa-sun-o text-gray-300' : 'fa-moon-o text-gray-600'}`; });
            Object.entries(elements.openers).forEach(([name, opener]) => opener.addEventListener('click', () => toggleModal(name, true)));
            $$('.close-modal-btn').forEach(btn => btn.addEventListener('click', (e) => e.target.closest('.fixed').classList.add('hidden')));
            elements.continueStoryBtn.addEventListener('click', () => generateChapter("接续上一章的情节，创作新的一章。"));
            elements.regenerateChapterBtn.addEventListener('click', () => { if (currentChapterIndex < 0) return; const prompt = story[currentChapterIndex].customPrompt || "用不同的视角或风格重写这一章。"; generateChapter(prompt, true); });
            elements.prevChapterBtn.addEventListener('click', () => renderChapter(currentChapterIndex - 1));
            elements.nextChapterBtn.addEventListener('click', () => renderChapter(currentChapterIndex + 1));
            elements.prevPageBtn.addEventListener('click', () => { if (currentPageIndex > 0) renderCurrentPage(--currentPageIndex); });
            elements.nextPageBtn.addEventListener('click', () => { if (currentPageIndex < chapterPages.length - 1) renderCurrentPage(++currentPageIndex); });
            [elements.fontSizeSlider, elements.lineHeightSlider, elements.dialogueBoldToggle, elements.dialogueColorPicker].forEach(el => el.addEventListener('input', applyReadingSettings));
            elements.resetDialogueColorBtn.addEventListener('click', () => { elements.dialogueColorPicker.value = document.documentElement.classList.contains('dark') ? '#cbd5e1' : '#334155'; applyReadingSettings(); });
            elements.fontUploadInput.addEventListener('change', (e) => { const file = e.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (event) => { const style = document.createElement('style'); style.textContent = `@font-face { font-family: 'CustomFont'; src: url('${event.target.result}'); }`; document.head.appendChild(style); document.documentElement.style.setProperty('--reading-font', `'CustomFont'`); }; reader.readAsDataURL(file); });
            elements.exportChapterBtn.addEventListener('click', () => { if(currentChapterIndex < 0) return; downloadAsTxt(`${story[currentChapterIndex].title}.txt`, story[currentChapterIndex].content); });
            elements.exportAllBtn.addEventListener('click', () => { if(!story.length) return; downloadAsTxt('Full Story.txt', story.map(c => `# ${c.title}\n\n${c.content}`).join('\n\n---\n\n')); });
            elements.submitCustomPromptBtn.addEventListener('click', () => { const prompt = elements.customPromptInput.value.trim(); if (prompt) { generateChapter(prompt); toggleModal('customPrompt', false); elements.customPromptInput.value = ''; } });
            elements.openers.editChapter.addEventListener('click', () => { if(currentChapterIndex < 0) return; const chapter = story[currentChapterIndex]; elements.editChapterTitleInput.value = chapter.title; elements.editChapterContentInput.value = chapter.content; });
            elements.saveEditBtn.addEventListener('click', () => { story[currentChapterIndex].title = elements.editChapterTitleInput.value.trim(); story[currentChapterIndex].content = elements.editChapterContentInput.value.trim(); renderChapter(currentChapterIndex); toggleModal('editChapter', false); });
            elements.deleteChapterBtn.addEventListener('click', () => { if (confirm('确定要删除本章吗？此操作无法撤销。')) { story.splice(currentChapterIndex, 1); const newIndex = Math.max(-1, currentChapterIndex - 1); renderChapter(newIndex); toggleModal('editChapter', false); } });
            elements.connectApiBtn.addEventListener('click', connectToApi);
            elements.apiTypeSelect.addEventListener('change', handleApiTypeChange);
            [elements.contextMemorySlider, elements.temperatureSlider, elements.modelSelect].forEach(el => el.addEventListener('input', () => { saveState(); updateUI(); }));
            
            elements.editApiKeysBtn.addEventListener('click', () => {
                apiConfig.keys = [];
                apiConfig.isConnected = false;
                elements.apiKeyInput.value = '';
                renderApiKeyDisplay();
                updateApiStatus('请重新输入API Key并连接。', 'loading');
                elements.modelSelect.disabled = true;
                elements.modelSelect.innerHTML = '<option value="">请先连接API</option>';
                saveState();
            });

            elements.presetTabsContainer.addEventListener('click', (e) => { const tab = e.target.closest('button')?.dataset.tab; if (tab) { activePresetTab = tab; renderPresetTabs(); renderPresetList(); } });
            elements.addPresetBtn.addEventListener('click', () => showPresetEditor());
            elements.presetListContainer.addEventListener('click', (e) => { const btn = e.target.closest('button'); const id = btn?.dataset.id; const action = btn?.dataset.action; if (action === 'edit-preset') { const item = presetData[activePresetTab].find(p => p.id === id); if (item) showPresetEditor(item); } else if (action === 'delete-preset') { if (confirm('确定删除此预设?')) { presetData[activePresetTab] = presetData[activePresetTab].filter(p => p.id !== id); selectedPresets[activePresetTab] = selectedPresets[activePresetTab].filter(pId => pId !== id); savePresets(); renderPresetList(); } } else { const container = e.target.closest('[data-action="toggle-select"]'); const selectId = container?.dataset.id; if (selectId) { const list = selectedPresets[activePresetTab]; const index = list.indexOf(selectId); if (index > -1) list.splice(index, 1); else list.push(selectId); savePresets(); renderPresetList(); } } });
            elements.generateFromPresetsBtn.addEventListener('click', () => { if (!Object.values(selectedPresets).some(arr => arr.length > 0)) return alert('请至少选择一个预设。'); generateChapter("根据所选预设开始第一章。"); toggleModal('storyPreset', false); });
        }

        // --- VIII. INITIALIZATION ---

        function initializeApp() {
            const savedTheme = localStorage.getItem(LS_KEYS.THEME);
            if (savedTheme === 'dark' || (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
                elements.themeToggleBtn.querySelector('i').className = 'fa fa-sun-o text-gray-300';
            }
            
            loadState();
            loadPresets();
            
            initializeEventListeners();
            applyReadingSettings(); 
            handleApiTypeChange();
            renderApiKeyDisplay();
            restoreApiConnectionUI();
            renderPresetTabs();
            renderPresetList();
            
            // MODIFIED: Explicit check for initial state
            if (story.length === 0 || currentChapterIndex < 0) {
                showWelcomeScreen();
            } else {
                renderChapter(currentChapterIndex); 
            }
        }

        initializeApp();
    });
  </script>
</body>
</html>
